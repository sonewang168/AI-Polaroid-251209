<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI æ‹ç«‹å¾—">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="AI æ‹ç«‹å¾—ç›¸æ©Ÿ v3 - Google ç›¸ç°¿æ•´åˆç‰ˆ">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <title>AI æ‹ç«‹å¾— v3</title>
    
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --ios-blue: #007AFF; --ios-green: #34C759; --ios-red: #FF3B30; --ios-orange: #FF9500;
            --ios-yellow: #FFCC00; --ios-pink: #FF2D55; --ios-purple: #AF52DE; --ios-teal: #5AC8FA;
            --theme-primary: #1D1D1F; --theme-secondary: #2D2D2F; --theme-accent: #86868B;
            --theme-highlight: #0A84FF; --theme-glass: rgba(29, 29, 31, 0.85);
            --theme-glass-light: rgba(255, 255, 255, 0.1); --theme-border: rgba(255, 255, 255, 0.15);
            --theme-text: #FFFFFF; --theme-text-secondary: rgba(255, 255, 255, 0.6);
            --theme-camera-body: linear-gradient(145deg, #2D2D2F 0%, #1D1D1F 50%, #0D0D0F 100%);
            --theme-shutter: #FFFFFF; --theme-shutter-border: rgba(255, 255, 255, 0.8);
            --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px);
            --spring: cubic-bezier(0.175, 0.885, 0.32, 1.275); --ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        /* iPhone 17 Pro éˆ¦é‡‘å±¬ç³»åˆ— */
        .theme-black-titanium { --theme-primary: #1D1D1F; --theme-secondary: #2D2D2F; --theme-accent: #86868B; --theme-highlight: #0A84FF; --theme-glass: rgba(29, 29, 31, 0.9); --theme-glass-light: rgba(255, 255, 255, 0.08); --theme-border: rgba(255, 255, 255, 0.12); --theme-text: #FFFFFF; --theme-text-secondary: rgba(255, 255, 255, 0.6); --theme-camera-body: linear-gradient(145deg, #3A3A3C 0%, #1D1D1F 50%, #000000 100%); --theme-shutter: #FFFFFF; --theme-shutter-border: rgba(255, 255, 255, 0.9); }
        .theme-white-titanium { --theme-primary: #F5F5F7; --theme-secondary: #E8E8ED; --theme-accent: #86868B; --theme-highlight: #0A84FF; --theme-glass: rgba(245, 245, 247, 0.9); --theme-glass-light: rgba(0, 0, 0, 0.05); --theme-border: rgba(0, 0, 0, 0.1); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --theme-camera-body: linear-gradient(145deg, #FFFFFF 0%, #E8E8ED 50%, #D1D1D6 100%); --theme-shutter: #1D1D1F; --theme-shutter-border: rgba(0, 0, 0, 0.6); }
        .theme-natural-titanium { --theme-primary: #ADA99F; --theme-secondary: #C4C0B6; --theme-accent: #8E8B82; --theme-highlight: #0A84FF; --theme-glass: rgba(173, 169, 159, 0.9); --theme-glass-light: rgba(255, 255, 255, 0.15); --theme-border: rgba(0, 0, 0, 0.1); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --theme-camera-body: linear-gradient(145deg, #C4C0B6 0%, #ADA99F 50%, #98948B 100%); --theme-shutter: #FFFFFF; --theme-shutter-border: rgba(255, 255, 255, 0.9); }
        .theme-desert-titanium { --theme-primary: #BFB5A0; --theme-secondary: #D4C9B5; --theme-accent: #A39A87; --theme-highlight: #FF9500; --theme-glass: rgba(191, 181, 160, 0.9); --theme-glass-light: rgba(255, 255, 255, 0.2); --theme-border: rgba(0, 0, 0, 0.1); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --theme-camera-body: linear-gradient(145deg, #D4C9B5 0%, #BFB5A0 50%, #A89F8B 100%); --theme-shutter: #FFFFFF; --theme-shutter-border: rgba(255, 255, 255, 0.9); }
        .theme-blue-titanium { --theme-primary: #394867; --theme-secondary: #4A5568; --theme-accent: #6B7C93; --theme-highlight: #5AC8FA; --theme-glass: rgba(57, 72, 103, 0.9); --theme-glass-light: rgba(255, 255, 255, 0.1); --theme-border: rgba(255, 255, 255, 0.15); --theme-text: #FFFFFF; --theme-text-secondary: rgba(255, 255, 255, 0.6); --theme-camera-body: linear-gradient(145deg, #4A5568 0%, #394867 50%, #2D3748 100%); --theme-shutter: #FFFFFF; --theme-shutter-border: rgba(255, 255, 255, 0.9); }
        .theme-pink { --theme-primary: #F9D5E5; --theme-secondary: #FCEAF0; --theme-accent: #E8A4C4; --theme-highlight: #FF2D55; --theme-glass: rgba(249, 213, 229, 0.9); --theme-glass-light: rgba(255, 255, 255, 0.4); --theme-border: rgba(0, 0, 0, 0.08); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --theme-camera-body: linear-gradient(145deg, #FCEAF0 0%, #F9D5E5 50%, #EFC4D8 100%); --theme-shutter: #1D1D1F; --theme-shutter-border: rgba(0, 0, 0, 0.5); }
        .theme-mint { --theme-primary: #C8E6D5; --theme-secondary: #DFF0E8; --theme-accent: #7DC4A5; --theme-highlight: #34C759; --theme-glass: rgba(200, 230, 213, 0.9); --theme-glass-light: rgba(255, 255, 255, 0.4); --theme-border: rgba(0, 0, 0, 0.08); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --theme-camera-body: linear-gradient(145deg, #DFF0E8 0%, #C8E6D5 50%, #B0D9C2 100%); --theme-shutter: #1D1D1F; --theme-shutter-border: rgba(0, 0, 0, 0.5); }
        .theme-sky { --theme-primary: #B8D4E8; --theme-secondary: #D0E4F0; --theme-accent: #6BAFCF; --theme-highlight: #5AC8FA; --theme-glass: rgba(184, 212, 232, 0.9); --theme-glass-light: rgba(255, 255, 255, 0.4); --theme-border: rgba(0, 0, 0, 0.08); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --theme-camera-body: linear-gradient(145deg, #D0E4F0 0%, #B8D4E8 50%, #9FC4DA 100%); --theme-shutter: #1D1D1F; --theme-shutter-border: rgba(0, 0, 0, 0.5); }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Noto Sans TC', -apple-system, sans-serif; background: var(--theme-primary); color: var(--theme-text); touch-action: manipulation; transition: background 0.5s ease, color 0.5s ease; }
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; overflow: hidden; opacity: 0; transition: opacity 0.8s ease; }
        .app-container.loaded { opacity: 1; }

        /* ========== é–‹æ©Ÿå‹•ç•« ========== */
        .boot-screen { position: fixed; inset: 0; z-index: 99999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease, visibility 0.8s ease; }
        .boot-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .boot-logo { position: relative; width: 180px; height: 180px; margin-bottom: 40px; }
        
        /* å¤–åœˆæ—‹è½‰å…‰ç’° */
        .boot-ring { position: absolute; inset: 0; border-radius: 50%; border: 2px solid transparent; }
        .boot-ring-1 { border-top-color: #0A84FF; border-right-color: #0A84FF; animation: bootSpin 2s linear infinite; }
        .boot-ring-2 { inset: 10px; border-bottom-color: #5E5CE6; border-left-color: #5E5CE6; animation: bootSpin 2.5s linear infinite reverse; }
        .boot-ring-3 { inset: 20px; border-top-color: #FF9500; animation: bootSpin 3s linear infinite; }
        
        @keyframes bootSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ä¸­å¤®ç›¸æ©Ÿåœ–æ¨™ */
        .boot-camera { position: absolute; inset: 30px; display: flex; align-items: center; justify-content: center; }
        .boot-camera-body { width: 100%; height: 75%; background: linear-gradient(145deg, #3A3A3C 0%, #1D1D1F 50%, #0D0D0F 100%); border-radius: 16px; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1); animation: bootFloat 3s ease-in-out infinite; }
        
        @keyframes bootFloat { 0%, 100% { transform: translateY(0) scale(1); } 50% { transform: translateY(-5px) scale(1.02); } }
        
        /* ç›¸æ©Ÿé¡é ­ */
        .boot-lens { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(145deg, #1A1A1C, #0D0D0F); position: relative; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5), inset 0 2px 4px rgba(255, 255, 255, 0.1); }
        .boot-lens::before { content: ''; position: absolute; inset: 6px; border-radius: 50%; background: conic-gradient(from 0deg, #0A84FF, #5E5CE6, #AF52DE, #FF2D55, #FF9500, #FFCC00, #34C759, #0A84FF); animation: bootLensRotate 4s linear infinite; }
        .boot-lens::after { content: ''; position: absolute; inset: 12px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #2D2D2F, #0D0D0F); box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5); }
        
        @keyframes bootLensRotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* é¡é ­åå…‰ */
        .boot-lens-flare { position: absolute; width: 16px; height: 16px; background: radial-gradient(circle, rgba(255, 255, 255, 0.8), transparent); border-radius: 50%; top: 18px; left: 18px; animation: bootFlare 2s ease-in-out infinite; z-index: 10; }
        
        @keyframes bootFlare { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.3); } }
        
        /* é–ƒå…‰ç‡ˆ */
        .boot-flash { position: absolute; top: 8px; right: 12px; width: 20px; height: 12px; background: linear-gradient(145deg, #FFD60A, #FF9500); border-radius: 4px; animation: bootFlash 2s ease-in-out infinite; }
        
        @keyframes bootFlash { 0%, 90%, 100% { opacity: 0.6; } 95% { opacity: 1; box-shadow: 0 0 20px #FFD60A; } }
        
        /* å¿«é–€æŒ‰éˆ• */
        .boot-shutter { position: absolute; top: -12px; left: 20px; width: 20px; height: 20px; background: linear-gradient(145deg, #FF453A, #FF2D55); border-radius: 50%; border: 3px solid #FFFFFF; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
        
        /* AI æ¨™ç±¤ */
        .boot-ai-badge { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #0A84FF, #5E5CE6); padding: 4px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; color: #FFFFFF; letter-spacing: 1px; }
        
        /* ç§‘æŠ€ç²’å­æ•ˆæœ */
        .boot-particles { position: absolute; inset: -50px; pointer-events: none; }
        .boot-particle { position: absolute; width: 4px; height: 4px; background: #0A84FF; border-radius: 50%; opacity: 0; }
        .boot-particle:nth-child(1) { left: 10%; top: 20%; animation: bootParticle 3s 0s infinite; }
        .boot-particle:nth-child(2) { left: 80%; top: 30%; animation: bootParticle 3s 0.5s infinite; background: #5E5CE6; }
        .boot-particle:nth-child(3) { left: 20%; top: 70%; animation: bootParticle 3s 1s infinite; background: #FF9500; }
        .boot-particle:nth-child(4) { left: 70%; top: 80%; animation: bootParticle 3s 1.5s infinite; background: #34C759; }
        .boot-particle:nth-child(5) { left: 50%; top: 10%; animation: bootParticle 3s 2s infinite; background: #FF2D55; }
        .boot-particle:nth-child(6) { left: 90%; top: 60%; animation: bootParticle 3s 2.5s infinite; }
        
        @keyframes bootParticle { 
            0% { opacity: 0; transform: scale(0) translateY(0); } 
            20% { opacity: 1; transform: scale(1) translateY(-10px); } 
            80% { opacity: 1; transform: scale(1) translateY(-30px); } 
            100% { opacity: 0; transform: scale(0) translateY(-50px); } 
        }
        
        /* æ¨™é¡Œæ–‡å­— */
        .boot-title { font-size: 32px; font-weight: 700; color: #FFFFFF; margin-bottom: 8px; opacity: 0; animation: bootFadeIn 1s 0.5s forwards; background: linear-gradient(135deg, #FFFFFF 0%, #A0A0A0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .boot-subtitle { font-size: 14px; color: rgba(255, 255, 255, 0.6); margin-bottom: 50px; opacity: 0; animation: bootFadeIn 1s 0.8s forwards; letter-spacing: 2px; }
        
        @keyframes bootFadeIn { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        
        /* é€²åº¦æ¢ */
        .boot-progress { width: 200px; height: 3px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden; opacity: 0; animation: bootFadeIn 1s 1s forwards; }
        .boot-progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #0A84FF, #5E5CE6, #AF52DE); border-radius: 2px; transition: width 0.3s ease; }
        
        /* è¼‰å…¥æ–‡å­— */
        .boot-status { font-size: 12px; color: rgba(255, 255, 255, 0.4); margin-top: 16px; opacity: 0; animation: bootFadeIn 1s 1.2s forwards; }
        
        /* ç‰ˆæœ¬è™Ÿ */
        .boot-version { position: absolute; bottom: 40px; font-size: 11px; color: rgba(255, 255, 255, 0.3); letter-spacing: 1px; }
        
        .status-bar { position: absolute; top: 0; left: 0; right: 0; height: calc(var(--safe-top) + 44px); padding-top: var(--safe-top); display: flex; align-items: center; justify-content: center; z-index: 100; pointer-events: none; }
        .dynamic-island { background: var(--theme-glass); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); padding: 8px 16px; border-radius: 24px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; box-shadow: 0 4px 24px rgba(0, 0, 0, 0.25); transition: all 0.4s var(--spring); pointer-events: auto; border: 1px solid var(--theme-border); }
        .dynamic-island.recording { background: var(--ios-red); animation: pulse 1.5s infinite; }
        .dynamic-island.uploading { background: var(--ios-green); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .island-icon { font-size: 16px; }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        
        .camera-view { flex: 1; position: relative; background: #000; overflow: hidden; }
        .camera-preview { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .camera-overlay { position: absolute; inset: 0; pointer-events: none; }
        .grid-overlay { position: absolute; inset: 0; display: none; }
        .grid-overlay.active { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); }
        .grid-overlay > div { border: 1px solid rgba(255, 255, 255, 0.25); }
        
        .camera-controls { position: absolute; bottom: 0; left: 0; right: 0; padding: 20px; padding-bottom: calc(20px + var(--safe-bottom) + 85px); background: linear-gradient(to top, var(--theme-primary) 0%, transparent 100%); }
        .top-controls { position: absolute; top: calc(var(--safe-top) + 54px); left: 0; right: 0; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; z-index: 50; }
        .control-btn { width: 48px; height: 48px; background: var(--theme-glass); backdrop-filter: blur(20px); border: 1px solid var(--theme-border); border-radius: 50%; color: var(--theme-text); font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.25s var(--ease-out); }
        .control-btn:active { transform: scale(0.92); }
        .control-btn.active { background: var(--theme-highlight); color: #fff; border-color: transparent; }
        
        .mode-selector { display: flex; justify-content: center; gap: 20px; margin-bottom: 28px; }
        .mode-btn { padding: 10px 16px; background: transparent; border: none; color: var(--theme-text-secondary); font-size: 13px; font-weight: 600; cursor: pointer; position: relative; transition: all 0.25s; }
        .mode-btn.active { color: var(--theme-highlight); }
        .mode-btn.active::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 8px; height: 8px; background: var(--theme-highlight); border-radius: 50%; }
        
        .shutter-area { display: flex; align-items: center; justify-content: center; gap: 55px; }
        .side-btn { width: 54px; height: 54px; background: var(--theme-glass); backdrop-filter: blur(20px); border: 1px solid var(--theme-border); border-radius: 50%; color: var(--theme-text); font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.25s var(--ease-out); overflow: hidden; }
        .side-btn img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .side-btn:active { transform: scale(0.92); }
        .shutter-btn { width: 85px; height: 85px; background: var(--theme-camera-body); border: 5px solid var(--theme-shutter-border); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s var(--ease-out); position: relative; }
        .shutter-btn::before { content: ''; width: 65px; height: 65px; background: var(--theme-shutter); border-radius: 50%; transition: all 0.15s; }
        .shutter-btn:active::before { transform: scale(0.88); opacity: 0.85; }
        
        .filter-strip, .frame-strip, .theme-strip { position: absolute; bottom: calc(165px + var(--safe-bottom)); left: 0; right: 0; padding: 15px 0; overflow-x: auto; overflow-y: hidden; white-space: nowrap; scrollbar-width: none; opacity: 0; transform: translateY(20px); transition: all 0.35s var(--ease-out); pointer-events: none; }
        .filter-strip::-webkit-scrollbar, .frame-strip::-webkit-scrollbar, .theme-strip::-webkit-scrollbar { display: none; }
        .filter-strip.active, .frame-strip.active, .theme-strip.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .filter-strip-inner, .frame-strip-inner, .theme-strip-inner { display: inline-flex; gap: 14px; padding: 0 20px; }
        
        .filter-item { width: 64px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: all 0.2s; }
        .filter-preview { width: 56px; height: 56px; border-radius: 12px; background: var(--theme-secondary); border: 2.5px solid transparent; overflow: hidden; transition: all 0.25s; }
        .filter-item.active .filter-preview { border-color: var(--theme-highlight); }
        .filter-name { font-size: 11px; color: var(--theme-text-secondary); font-weight: 500; }
        .filter-item.active .filter-name { color: var(--theme-highlight); }
        
        .theme-item { width: 56px; display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: all 0.25s; }
        .theme-preview { width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2); transition: all 0.25s; }
        .theme-item.active .theme-preview { border-color: var(--theme-highlight); transform: scale(1.08); }
        .theme-name { font-size: 10px; color: var(--theme-text-secondary); font-weight: 500; text-align: center; }
        .theme-item.active .theme-name { color: var(--theme-highlight); }
        .theme-preview.black-titanium { background: linear-gradient(145deg, #3A3A3C, #1D1D1F); }
        .theme-preview.white-titanium { background: linear-gradient(145deg, #FFFFFF, #E8E8ED); }
        .theme-preview.natural-titanium { background: linear-gradient(145deg, #C4C0B6, #ADA99F); }
        .theme-preview.desert-titanium { background: linear-gradient(145deg, #D4C9B5, #BFB5A0); }
        .theme-preview.blue-titanium { background: linear-gradient(145deg, #4A5568, #394867); }
        .theme-preview.pink { background: linear-gradient(145deg, #FCEAF0, #F9D5E5); }
        .theme-preview.mint { background: linear-gradient(145deg, #DFF0E8, #C8E6D5); }
        .theme-preview.sky { background: linear-gradient(145deg, #D0E4F0, #B8D4E8); }
        
        .tab-bar { position: absolute; bottom: 0; left: 0; right: 0; height: calc(85px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: var(--theme-glass); backdrop-filter: blur(40px); border-top: 0.5px solid var(--theme-border); display: flex; justify-content: space-around; align-items: center; z-index: 200; }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 10px; background: transparent; border: none; color: var(--theme-text-secondary); cursor: pointer; transition: all 0.25s; }
        .tab-item.active { color: var(--theme-highlight); }
        .tab-icon { font-size: 26px; }
        .tab-label { font-size: 11px; font-weight: 600; }
        
        .page-view { position: absolute; inset: 0; background: var(--theme-primary); z-index: 300; transform: translateX(100%); transition: transform 0.4s var(--ease-out); display: flex; flex-direction: column; }
        .page-view.active { transform: translateX(0); }
        .page-header { height: calc(var(--safe-top) + 60px); padding-top: var(--safe-top); background: var(--theme-glass); backdrop-filter: blur(30px); border-bottom: 0.5px solid var(--theme-border); display: flex; align-items: center; justify-content: space-between; padding-left: 18px; padding-right: 18px; }
        .page-title { font-size: 18px; font-weight: 700; }
        .page-btn { padding: 10px 14px; background: transparent; border: none; color: var(--theme-highlight); font-size: 17px; cursor: pointer; font-weight: 500; }
        .page-content { flex: 1; overflow-y: auto; padding: 18px; padding-bottom: calc(18px + var(--safe-bottom)); }
        
        /* ç›¸ç°¿ */
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
        .photo-thumb { aspect-ratio: 1; background: var(--theme-secondary); cursor: pointer; overflow: hidden; position: relative; border-radius: 4px; }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.25s; }
        .photo-thumb:active img { transform: scale(1.05); }
        .photo-thumb .upload-badge { position: absolute; top: 4px; right: 4px; font-size: 12px; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 4px; }
        .photo-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; color: var(--theme-text-secondary); gap: 16px; }
        .photo-empty-icon { font-size: 72px; opacity: 0.4; }
        
        /* è¨­å®š */
        .settings-section { background: var(--theme-secondary); border-radius: 14px; margin-bottom: 22px; overflow: hidden; }
        .settings-header { padding: 14px 18px; font-size: 13px; font-weight: 600; color: var(--theme-text-secondary); text-transform: uppercase; }
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 18px; background: var(--theme-glass-light); border-bottom: 0.5px solid var(--theme-border); }
        .settings-item:last-child { border-bottom: none; }
        .settings-label { display: flex; align-items: center; gap: 14px; font-size: 16px; font-weight: 500; }
        .settings-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 17px; }
        .settings-value { color: var(--theme-text-secondary); font-size: 14px; max-width: 150px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
        .ios-switch { width: 52px; height: 32px; background: var(--theme-accent); border-radius: 16px; position: relative; cursor: pointer; transition: background 0.3s; }
        .ios-switch.active { background: var(--ios-green); }
        .ios-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 28px; height: 28px; background: #fff; border-radius: 50%; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25); transition: transform 0.3s var(--spring); }
        .ios-switch.active::after { transform: translateX(20px); }
        
        .input-field { width: 100%; padding: 12px 14px; background: var(--theme-primary); border: 2px solid var(--theme-border); border-radius: 10px; color: var(--theme-text); font-size: 14px; }
        .input-field:focus { outline: none; border-color: var(--theme-highlight); }
        .btn { width: 100%; padding: 14px 20px; border: none; border-radius: 12px; font-size: 1em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--ios-blue) 0%, var(--ios-purple) 100%); color: white; }
        .btn-google { background: #fff; color: #333; border: 1px solid #ddd; }
        .btn-line { background: #06C755; color: white; }
        .btn-danger { background: var(--ios-red); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--theme-highlight); color: var(--theme-highlight); }
        
        .auth-status { padding: 12px 16px; border-radius: 10px; font-size: 14px; margin: 10px 0; text-align: center; }
        .auth-status.success { background: rgba(52, 199, 89, 0.2); color: var(--ios-green); }
        .auth-status.error { background: rgba(255, 59, 48, 0.2); color: var(--ios-red); }
        .auth-status.pending { background: rgba(255, 149, 0, 0.2); color: var(--ios-orange); }
        
        /* ç…§ç‰‡æª¢è¦–å™¨ */
        .photo-viewer { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.96); z-index: 500; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: opacity 0.35s; }
        .photo-viewer.active { opacity: 1; pointer-events: auto; }
        .viewer-header { height: calc(var(--safe-top) + 55px); padding-top: var(--safe-top); display: flex; align-items: center; justify-content: space-between; padding: 0 18px; padding-top: var(--safe-top); }
        .viewer-content { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .viewer-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 12px; }
        .viewer-actions { height: calc(85px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); display: flex; justify-content: space-around; align-items: center; background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(20px); }
        .viewer-btn { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 10px 22px; background: transparent; border: none; color: var(--ios-blue); cursor: pointer; font-size: 12px; font-weight: 500; }
        .viewer-btn-icon { font-size: 26px; }
        
        /* ä¸Šå‚³é€²åº¦ */
        .upload-progress { position: fixed; bottom: 100px; left: 20px; right: 20px; background: var(--theme-glass); backdrop-filter: blur(20px); border-radius: 16px; padding: 16px; z-index: 600; transform: translateY(100px); opacity: 0; transition: all 0.3s var(--ease-out); }
        .upload-progress.active { transform: translateY(0); opacity: 1; }
        .progress-bar { height: 6px; background: var(--theme-border); border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--ios-green); border-radius: 3px; transition: width 0.3s; }
        
        /* Toast */
        .toast { position: fixed; top: calc(var(--safe-top) + 65px); left: 50%; transform: translateX(-50%) translateY(-25px); background: var(--theme-glass); backdrop-filter: blur(30px); padding: 14px 28px; border-radius: 28px; font-size: 15px; font-weight: 600; z-index: 900; opacity: 0; pointer-events: none; transition: all 0.4s var(--spring); display: flex; align-items: center; gap: 10px; border: 1px solid var(--theme-border); }
        .toast.active { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .flash-overlay { position: fixed; inset: 0; background: #fff; z-index: 700; opacity: 0; pointer-events: none; }
        .flash-overlay.active { animation: flashEffect 0.35s ease-out; }
        @keyframes flashEffect { 0% { opacity: 1; } 100% { opacity: 0; } }
        
        .hidden { display: none !important; }
        
        /* å„²å­˜çµ±è¨ˆ */
        .storage-stats { background: var(--theme-glass-light); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .storage-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .storage-label { color: var(--theme-text-secondary); }
        .storage-value { color: var(--theme-highlight); font-weight: 600; }
    </style>
</head>
<body class="theme-black-titanium">
    <!-- ========== é–‹æ©Ÿå‹•ç•« ========== -->
    <div class="boot-screen" id="bootScreen">
        <div class="boot-logo">
            <!-- æ—‹è½‰å…‰ç’° -->
            <div class="boot-ring boot-ring-1"></div>
            <div class="boot-ring boot-ring-2"></div>
            <div class="boot-ring boot-ring-3"></div>
            
            <!-- ç§‘æŠ€ç²’å­ -->
            <div class="boot-particles">
                <div class="boot-particle"></div>
                <div class="boot-particle"></div>
                <div class="boot-particle"></div>
                <div class="boot-particle"></div>
                <div class="boot-particle"></div>
                <div class="boot-particle"></div>
            </div>
            
            <!-- ç›¸æ©Ÿä¸»é«” -->
            <div class="boot-camera">
                <div class="boot-camera-body">
                    <div class="boot-shutter"></div>
                    <div class="boot-flash"></div>
                    <div class="boot-lens">
                        <div class="boot-lens-flare"></div>
                    </div>
                    <div class="boot-ai-badge">AI</div>
                </div>
            </div>
        </div>
        
        <div class="boot-title">AI æ‹ç«‹å¾—</div>
        <div class="boot-subtitle">POLAROID CAMERA</div>
        
        <div class="boot-progress">
            <div class="boot-progress-bar" id="bootProgressBar"></div>
        </div>
        <div class="boot-status" id="bootStatus">æ­£åœ¨åˆå§‹åŒ–...</div>
        
        <div class="boot-version">v3.0.0 â€¢ Google Photos Edition</div>
    </div>
    
    <div class="app-container" id="appContainer">
        <div class="status-bar"><div class="dynamic-island" id="dynamicIsland"><span class="island-icon">ğŸ“·</span><span id="islandText">AI æ‹ç«‹å¾— v3</span></div></div>
        <div class="main-content">
            <div class="camera-view" id="cameraView">
                <video class="camera-preview" id="cameraPreview" autoplay playsinline muted></video>
                <div class="camera-overlay"><div class="grid-overlay" id="gridOverlay"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>
                <div class="top-controls"><button class="control-btn" id="flashBtn" onclick="toggleFlash()">âš¡</button><div style="display: flex; gap: 12px;"><button class="control-btn" id="gridBtn" onclick="toggleGrid()">âŠ</button><button class="control-btn" id="timerBtn" onclick="cycleTimer()">â±</button><button class="control-btn" id="flipBtn" onclick="flipCamera()">ğŸ”„</button></div></div>
                <div class="filter-strip" id="filterStrip"><div class="filter-strip-inner" id="filterStripInner"></div></div>
                <div class="theme-strip" id="themeStrip"><div class="theme-strip-inner" id="themeStripInner"></div></div>
                <div class="camera-controls">
                    <div class="mode-selector"><button class="mode-btn" data-mode="filter" onclick="setControlMode('filter')">æ¿¾é¡</button><button class="mode-btn active" data-mode="photo" onclick="setControlMode('photo')">ç…§ç‰‡</button><button class="mode-btn" data-mode="theme" onclick="setControlMode('theme')">å¤–è§€</button></div>
                    <div class="shutter-area"><button class="side-btn" id="galleryBtn" onclick="showPage('gallery')"><span id="lastPhotoThumb">ğŸ–¼ï¸</span></button><button class="shutter-btn" id="shutterBtn" onclick="takePhoto()"></button><button class="side-btn" onclick="uploadAllPending()">â˜ï¸</button></div>
                </div>
            </div>
        </div>
        <nav class="tab-bar"><button class="tab-item active" data-tab="camera" onclick="switchTab('camera')"><span class="tab-icon">ğŸ“·</span><span class="tab-label">ç›¸æ©Ÿ</span></button><button class="tab-item" data-tab="gallery" onclick="switchTab('gallery')"><span class="tab-icon">ğŸ–¼ï¸</span><span class="tab-label">ç›¸ç°¿</span></button><button class="tab-item" data-tab="cloud" onclick="switchTab('cloud')"><span class="tab-icon">â˜ï¸</span><span class="tab-label">é›²ç«¯</span></button><button class="tab-item" data-tab="settings" onclick="switchTab('settings')"><span class="tab-icon">âš™ï¸</span><span class="tab-label">è¨­å®š</span></button></nav>
        
        <!-- ç›¸ç°¿é é¢ -->
        <div class="page-view" id="galleryPage">
            <div class="page-header"><button class="page-btn" onclick="closePage('gallery')">â† è¿”å›</button><span class="page-title">æˆ‘çš„ç…§ç‰‡</span><button class="page-btn" onclick="clearAllPhotos()">æ¸…é™¤</button></div>
            <div class="page-content">
                <div class="storage-stats" id="storageStats">
                    <div class="storage-row"><span class="storage-label">ğŸ“· ç…§ç‰‡æ•¸é‡</span><span class="storage-value" id="photoCount">0</span></div>
                    <div class="storage-row"><span class="storage-label">â˜ï¸ å·²ä¸Šå‚³</span><span class="storage-value" id="uploadedCount">0</span></div>
                    <div class="storage-row"><span class="storage-label">â³ å¾…ä¸Šå‚³</span><span class="storage-value" id="pendingCount">0</span></div>
                </div>
                <div class="photo-grid" id="photoGrid"></div>
                <div class="photo-empty" id="photoEmpty"><span class="photo-empty-icon">ğŸ“·</span><span>é‚„æ²’æœ‰ç…§ç‰‡</span><span style="font-size: 14px; opacity: 0.6;">ç…§ç‰‡å„²å­˜åœ¨ IndexedDBï¼Œä¸ä½”è¨˜æ†¶é«”</span></div>
            </div>
        </div>
        
        <!-- é›²ç«¯é é¢ -->
        <div class="page-view" id="cloudPage">
            <div class="page-header"><button class="page-btn" onclick="closePage('cloud')">â† è¿”å›</button><span class="page-title">é›²ç«¯åŒæ­¥</span><span></span></div>
            <div class="page-content">
                <!-- Google ç›¸ç°¿ -->
                <div class="settings-section">
                    <div class="settings-header">ğŸ“· Google ç›¸ç°¿</div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #4285F4;">G</div><span>Client ID</span></div></div>
                    <div style="padding: 0 18px 16px;">
                        <input type="text" class="input-field" id="googleClientId" placeholder="è¼¸å…¥ Google OAuth Client ID">
                    </div>
                    <div id="googleAuthStatus" class="auth-status" style="display: none; margin: 0 18px 16px;"></div>
                    <div style="padding: 0 18px 16px; display: flex; gap: 10px;">
                        <button class="btn btn-google" style="flex: 1;" onclick="authorizeGoogle()">ğŸ”‘ æˆæ¬Š Google</button>
                        <button class="btn btn-outline" style="flex: 1;" onclick="reauthorizeGoogle()">ğŸ”„ é‡æ–°æˆæ¬Š</button>
                    </div>
                </div>
                
                <!-- LINE é€šçŸ¥ -->
                <div class="settings-section">
                    <div class="settings-header">ğŸ’¬ LINE ä¸Šå‚³é€šçŸ¥</div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #06C755;">L</div><span>GAS URL</span></div></div>
                    <div style="padding: 0 18px 16px;">
                        <input type="text" class="input-field" id="lineGasUrl" placeholder="Google Apps Script éƒ¨ç½²ç¶²å€">
                    </div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #06C755;">ğŸ”</div><span>GAS Secret</span></div></div>
                    <div style="padding: 0 18px 16px;">
                        <input type="password" class="input-field" id="lineGasSecret" placeholder="GAS é©—è­‰å¯†é‘°">
                    </div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #06C755;">ğŸ«</div><span>LINE Token</span></div></div>
                    <div style="padding: 0 18px 16px;">
                        <input type="password" class="input-field" id="lineToken" placeholder="LINE Messaging API Token">
                    </div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #06C755;">ğŸ‘¤</div><span>LINE User ID</span></div></div>
                    <div style="padding: 0 18px 16px;">
                        <input type="text" class="input-field" id="lineUserId" placeholder="ä½ çš„ LINE User ID">
                    </div>
                    <div style="padding: 0 18px 16px;">
                        <button class="btn btn-line" onclick="testLineNotification()">ğŸ“¤ æ¸¬è©¦ LINE é€šçŸ¥</button>
                    </div>
                </div>
                
                <!-- ä¸Šå‚³è¨­å®š -->
                <div class="settings-section">
                    <div class="settings-header">âš™ï¸ ä¸Šå‚³è¨­å®š</div>
                    <div class="settings-item">
                        <div class="settings-label"><div class="settings-icon" style="background: var(--ios-green);">ğŸ“¤</div><span>æ‹ç…§å¾Œè‡ªå‹•ä¸Šå‚³</span></div>
                        <div class="ios-switch" id="autoUploadSwitch" onclick="toggleSetting('autoUpload')"></div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label"><div class="settings-icon" style="background: var(--ios-blue);">ğŸ’¬</div><span>ä¸Šå‚³å¾Œ LINE é€šçŸ¥</span></div>
                        <div class="ios-switch active" id="lineNotifySwitch" onclick="toggleSetting('lineNotify')"></div>
                    </div>
                </div>
                
                <button class="btn btn-primary" style="margin-top: 10px;" onclick="saveCloudSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
            </div>
        </div>
        
        <!-- è¨­å®šé é¢ -->
        <div class="page-view" id="settingsPage">
            <div class="page-header"><button class="page-btn" onclick="closePage('settings')">â† è¿”å›</button><span class="page-title">è¨­å®š</span><span></span></div>
            <div class="page-content">
                <div class="settings-section">
                    <div class="settings-header">ç›¸æ©Ÿè¨­å®š</div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: var(--ios-yellow);">âŠ</div><span>é¡¯ç¤ºç¶²æ ¼ç·š</span></div><div class="ios-switch" id="gridSwitch" onclick="toggleSetting('grid')"></div></div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: var(--ios-orange);">ğŸ”Š</div><span>å¿«é–€è²éŸ³</span></div><div class="ios-switch active" id="soundSwitch" onclick="toggleSetting('sound')"></div></div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">AI è¨­å®š</div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: var(--ios-purple);">ğŸ”‘</div><span>Gemini API Key</span></div><button class="page-btn" onclick="showAPIKeyInput()">è¨­å®š â†’</button></div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: var(--ios-green);">âœ“</div><span>API ç‹€æ…‹</span></div><span class="settings-value" id="apiStatus">æœªé€£æ¥</span></div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">å„²å­˜ç©ºé–“</div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: var(--ios-teal);">ğŸ’¾</div><span>å„²å­˜æ–¹å¼</span></div><span class="settings-value">IndexedDB</span></div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: var(--ios-orange);">ğŸ“Š</div><span>ç…§ç‰‡å®¹é‡</span></div><span class="settings-value" id="storageSize">è¨ˆç®—ä¸­...</span></div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">é—œæ–¼</div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: var(--ios-teal);">â„¹ï¸</div><span>ç‰ˆæœ¬</span></div><span class="settings-value">3.0.0</span></div>
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: var(--ios-pink);">ğŸ‘¨â€ğŸ’»</div><span>é–‹ç™¼è€…</span></div><span class="settings-value">Sone Wang</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç…§ç‰‡æª¢è¦–å™¨ -->
    <div class="photo-viewer" id="photoViewer">
        <div class="viewer-header"><button class="page-btn" onclick="closeViewer()">âœ• é—œé–‰</button><span id="viewerUploadStatus"></span></div>
        <div class="viewer-content"><img class="viewer-image" id="viewerImage" src="" alt="Photo"></div>
        <div class="viewer-actions">
            <button class="viewer-btn" onclick="downloadCurrentPhoto()"><span class="viewer-btn-icon">â¬‡ï¸</span><span>ä¸‹è¼‰</span></button>
            <button class="viewer-btn" onclick="uploadCurrentPhoto()"><span class="viewer-btn-icon">â˜ï¸</span><span>ä¸Šå‚³</span></button>
            <button class="viewer-btn" onclick="deleteCurrentPhoto()" style="color: var(--ios-red);"><span class="viewer-btn-icon">ğŸ—‘ï¸</span><span>åˆªé™¤</span></button>
        </div>
    </div>
    
    <!-- ä¸Šå‚³é€²åº¦ -->
    <div class="upload-progress" id="uploadProgress">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span id="uploadProgressText">ä¸Šå‚³ä¸­...</span>
            <span id="uploadProgressPercent">0%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="uploadProgressFill" style="width: 0%;"></div></div>
    </div>
    
    <div class="flash-overlay" id="flashOverlay"></div>
    <div class="toast" id="toast"><span id="toastIcon">âœ“</span><span id="toastText">å·²å„²å­˜</span></div>

    <script>
        // ============================================
        // å…¨åŸŸè®Šæ•¸
        // ============================================
        let db = null;
        const DB_NAME = 'AIPolaroidDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'photos';
        
        let stream = null, currentCamera = 'user';
        let currentFilter = 'none', currentTheme = 'black-titanium';
        let controlMode = 'photo', timerSeconds = 0;
        let flashEnabled = false, gridEnabled = false, soundEnabled = true;
        let autoUploadEnabled = false, lineNotifyEnabled = true;
        let geminiApiKey = '', currentPhotoId = null;
        
        // Google OAuth
        const SCOPES = 'https://www.googleapis.com/auth/photoslibrary.appendonly';
        const TOKEN_KEY = 'polaroid_google_token';
        let tokenClient = null;
        
        const filters = [
            { id: 'none', name: 'åŸå§‹', css: '' },
            { id: 'vintage', name: 'å¾©å¤', css: 'sepia(0.4) contrast(1.1) brightness(1.05)' },
            { id: 'bw', name: 'é»‘ç™½', css: 'grayscale(1) contrast(1.1)' },
            { id: 'warm', name: 'æš–è‰²', css: 'sepia(0.2) saturate(1.3) brightness(1.05)' },
            { id: 'cool', name: 'å†·è‰²', css: 'saturate(0.9) brightness(1.1) hue-rotate(10deg)' },
            { id: 'vivid', name: 'é®®è±”', css: 'contrast(1.1) saturate(1.5) brightness(1.05)' }
        ];
        
        const themes = [
            { id: 'black-titanium', name: 'é»‘è‰²éˆ¦é‡‘å±¬' },
            { id: 'white-titanium', name: 'ç™½è‰²éˆ¦é‡‘å±¬' },
            { id: 'natural-titanium', name: 'è‡ªç„¶éˆ¦é‡‘å±¬' },
            { id: 'desert-titanium', name: 'æ²™æ¼ éˆ¦é‡‘å±¬' },
            { id: 'blue-titanium', name: 'è—è‰²éˆ¦é‡‘å±¬' },
            { id: 'pink', name: 'ç²‰ç´…' },
            { id: 'mint', name: 'è–„è·ç¶ ' },
            { id: 'sky', name: 'å¤©è—' }
        ];

        // ============================================
        // IndexedDB åˆå§‹åŒ–
        // ============================================
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        const store = database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('uploaded', 'uploaded', { unique: false });
                    }
                };
            });
        }

        // å„²å­˜ç…§ç‰‡åˆ° IndexedDB
        async function savePhotoToDB(photoData) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const photo = {
                    id: Date.now(),
                    data: photoData,
                    timestamp: new Date().toISOString(),
                    filter: currentFilter,
                    uploaded: false,
                    googlePhotoId: null
                };
                
                const request = store.add(photo);
                request.onsuccess = () => resolve(photo);
                request.onerror = () => reject(request.error);
            });
        }

        // å–å¾—æ‰€æœ‰ç…§ç‰‡
        async function getAllPhotos() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const photos = request.result.sort((a, b) => b.id - a.id);
                    resolve(photos);
                };
                request.onerror = () => reject(request.error);
            });
        }

        // å–å¾—å–®å¼µç…§ç‰‡
        async function getPhoto(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // æ›´æ–°ç…§ç‰‡ç‹€æ…‹
        async function updatePhoto(id, updates) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const getRequest = store.get(id);
                
                getRequest.onsuccess = () => {
                    const photo = getRequest.result;
                    if (photo) {
                        Object.assign(photo, updates);
                        const putRequest = store.put(photo);
                        putRequest.onsuccess = () => resolve(photo);
                        putRequest.onerror = () => reject(putRequest.error);
                    } else {
                        reject(new Error('Photo not found'));
                    }
                };
                getRequest.onerror = () => reject(getRequest.error);
            });
        }

        // åˆªé™¤ç…§ç‰‡
        async function deletePhotoFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // æ¸…é™¤æ‰€æœ‰ç…§ç‰‡
        async function clearAllPhotosFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // è¨ˆç®—å„²å­˜ç©ºé–“
        async function calculateStorageSize() {
            const photos = await getAllPhotos();
            let totalSize = 0;
            photos.forEach(photo => {
                totalSize += photo.data.length * 0.75; // base64 è½‰ bytes ç´„æ¯”ä¾‹
            });
            
            if (totalSize < 1024 * 1024) {
                return (totalSize / 1024).toFixed(1) + ' KB';
            } else {
                return (totalSize / (1024 * 1024)).toFixed(1) + ' MB';
            }
        }

        // ============================================
        // Google OAuth èªè­‰
        // ============================================
        function isTokenValid() {
            const tokenData = localStorage.getItem(TOKEN_KEY);
            if (!tokenData) return false;
            const { expiry } = JSON.parse(tokenData);
            return expiry && Date.now() < expiry;
        }

        function getAccessToken() {
            const tokenData = localStorage.getItem(TOKEN_KEY);
            if (!tokenData) return null;
            return JSON.parse(tokenData).access_token;
        }

        function saveGoogleToken(response) {
            const tokenData = {
                access_token: response.access_token,
                expiry: Date.now() + (response.expires_in * 1000)
            };
            localStorage.setItem(TOKEN_KEY, JSON.stringify(tokenData));
        }

        function initTokenClient() {
            const clientId = document.getElementById('googleClientId').value.trim();
            if (!clientId) {
                showToast('âš ï¸', 'è«‹å…ˆè¼¸å…¥ Google Client ID');
                return false;
            }
            if (typeof google === 'undefined' || !google.accounts) {
                showToast('âŒ', 'Google API å°šæœªè¼‰å…¥');
                return false;
            }
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error) {
                        showToast('âŒ', 'æˆæ¬Šå¤±æ•—: ' + response.error);
                        updateAuthStatus('error', 'âŒ æˆæ¬Šå¤±æ•—');
                        return;
                    }
                    saveGoogleToken(response);
                    updateAuthStatus('success', 'âœ… å·²æˆæ¬Šï¼ˆ1 å°æ™‚æœ‰æ•ˆï¼‰');
                    showToast('âœ…', 'Google ç›¸ç°¿æˆæ¬ŠæˆåŠŸï¼');
                    saveCloudSettings();
                }
            });
            return true;
        }

        function authorizeGoogle() {
            if (isTokenValid()) {
                showToast('âœ…', 'æˆæ¬Šä»ç„¶æœ‰æ•ˆ');
                updateAuthStatus('success', 'âœ… å·²æˆæ¬Š');
                return;
            }
            if (!initTokenClient()) return;
            tokenClient.requestAccessToken({ prompt: '' });
        }

        function reauthorizeGoogle() {
            if (!confirm('ç¢ºå®šè¦é‡æ–°æˆæ¬Šå—ï¼Ÿ')) return;
            localStorage.removeItem(TOKEN_KEY);
            if (!initTokenClient()) return;
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function updateAuthStatus(type, message) {
            const statusEl = document.getElementById('googleAuthStatus');
            statusEl.textContent = message;
            statusEl.className = `auth-status ${type}`;
            statusEl.style.display = 'block';
        }

        // ============================================
        // Google ç›¸ç°¿ä¸Šå‚³
        // ============================================
        async function uploadToGooglePhotos(photoData, photoId) {
            if (!isTokenValid()) {
                showToast('âš ï¸', 'è«‹å…ˆæˆæ¬Š Google ç›¸ç°¿');
                return false;
            }

            const accessToken = getAccessToken();
            
            try {
                // 1. ä¸Šå‚³åœ–ç‰‡ bytes
                const base64Data = photoData.split(',')[1];
                const binaryData = atob(base64Data);
                const bytes = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    bytes[i] = binaryData.charCodeAt(i);
                }
                
                const uploadResponse = await fetch('https://photoslibrary.googleapis.com/v1/uploads', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/octet-stream',
                        'X-Goog-Upload-Content-Type': 'image/jpeg',
                        'X-Goog-Upload-Protocol': 'raw'
                    },
                    body: bytes
                });
                
                if (!uploadResponse.ok) {
                    throw new Error('ä¸Šå‚³å¤±æ•—');
                }
                
                const uploadToken = await uploadResponse.text();
                
                // 2. å»ºç«‹åª’é«”é …ç›®
                const createResponse = await fetch('https://photoslibrary.googleapis.com/v1/mediaItems:batchCreate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        newMediaItems: [{
                            description: `AI æ‹ç«‹å¾— - ${new Date().toLocaleString('zh-TW')}`,
                            simpleMediaItem: {
                                uploadToken: uploadToken,
                                fileName: `polaroid_${Date.now()}.jpg`
                            }
                        }]
                    })
                });
                
                const createResult = await createResponse.json();
                
                if (createResult.newMediaItemResults?.[0]?.status?.message === 'Success' || 
                    createResult.newMediaItemResults?.[0]?.mediaItem) {
                    
                    const mediaItem = createResult.newMediaItemResults[0].mediaItem;
                    
                    // æ›´æ–°ç…§ç‰‡ç‹€æ…‹
                    await updatePhoto(photoId, {
                        uploaded: true,
                        googlePhotoId: mediaItem?.id || 'uploaded'
                    });
                    
                    return { success: true, mediaItem };
                } else {
                    throw new Error('å»ºç«‹åª’é«”é …ç›®å¤±æ•—');
                }
                
            } catch (err) {
                console.error('ä¸Šå‚³éŒ¯èª¤:', err);
                return { success: false, error: err.message };
            }
        }

        // ============================================
        // LINE é€šçŸ¥
        // ============================================
        async function sendLineNotification(message) {
            const gasUrl = document.getElementById('lineGasUrl')?.value || localStorage.getItem('lineGasUrl');
            const gasSecret = document.getElementById('lineGasSecret')?.value || localStorage.getItem('lineGasSecret');
            const lineToken = document.getElementById('lineToken')?.value || localStorage.getItem('lineToken');
            const lineUserId = document.getElementById('lineUserId')?.value || localStorage.getItem('lineUserId');
            
            if (!gasUrl || !gasSecret || !lineToken || !lineUserId) {
                console.log('LINE è¨­å®šä¸å®Œæ•´');
                return false;
            }
            
            try {
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        secret: gasSecret,
                        token: lineToken,
                        userId: lineUserId,
                        message: message
                    })
                });
                
                const result = await response.json();
                return result.success;
            } catch (err) {
                console.error('LINE é€šçŸ¥éŒ¯èª¤:', err);
                return false;
            }
        }

        function testLineNotification() {
            showToast('ğŸ“¤', 'ç™¼é€æ¸¬è©¦é€šçŸ¥...');
            sendLineNotification('ğŸ§ª æ¸¬è©¦é€šçŸ¥\n\nğŸ“· AI æ‹ç«‹å¾— v3 å·²æˆåŠŸé€£æ¥ï¼\n\nâœ… LINE é€šçŸ¥åŠŸèƒ½æ­£å¸¸é‹ä½œ')
                .then(success => {
                    if (success) {
                        showToast('âœ…', 'LINE é€šçŸ¥ç™¼é€æˆåŠŸï¼');
                    } else {
                        showToast('âŒ', 'LINE é€šçŸ¥ç™¼é€å¤±æ•—');
                    }
                });
        }

        // ============================================
        // ä¸Šå‚³åŠŸèƒ½æ•´åˆ
        // ============================================
        async function uploadCurrentPhoto() {
            if (!currentPhotoId) return;
            
            const photo = await getPhoto(currentPhotoId);
            if (!photo) return;
            
            if (photo.uploaded) {
                showToast('âœ…', 'æ­¤ç…§ç‰‡å·²ä¸Šå‚³é');
                return;
            }
            
            showUploadProgress('ä¸Šå‚³ä¸­...', 0);
            updateIsland('â˜ï¸', 'ä¸Šå‚³ä¸­...');
            document.getElementById('dynamicIsland').classList.add('uploading');
            
            const result = await uploadToGooglePhotos(photo.data, photo.id);
            
            if (result.success) {
                showUploadProgress('ä¸Šå‚³æˆåŠŸï¼', 100);
                showToast('âœ…', 'å·²ä¸Šå‚³åˆ° Google ç›¸ç°¿');
                
                // ç™¼é€ LINE é€šçŸ¥
                if (lineNotifyEnabled) {
                    const timestamp = new Date().toLocaleString('zh-TW');
                    await sendLineNotification(`ğŸ“· ç…§ç‰‡å·²ä¸Šå‚³æˆåŠŸï¼\n\nâ° æ™‚é–“ï¼š${timestamp}\nâ˜ï¸ å·²åŒæ­¥åˆ° Google ç›¸ç°¿\n\nâœ¨ AI æ‹ç«‹å¾— v3`);
                }
                
                document.getElementById('viewerUploadStatus').textContent = 'â˜ï¸ å·²ä¸Šå‚³';
                await updateGallery();
            } else {
                showToast('âŒ', 'ä¸Šå‚³å¤±æ•—: ' + result.error);
            }
            
            document.getElementById('dynamicIsland').classList.remove('uploading');
            updateIsland('ğŸ“·', 'AI æ‹ç«‹å¾— v3');
            
            setTimeout(() => hideUploadProgress(), 1500);
        }

        async function uploadAllPending() {
            const photos = await getAllPhotos();
            const pending = photos.filter(p => !p.uploaded);
            
            if (pending.length === 0) {
                showToast('âœ…', 'æ²’æœ‰å¾…ä¸Šå‚³çš„ç…§ç‰‡');
                return;
            }
            
            if (!isTokenValid()) {
                showToast('âš ï¸', 'è«‹å…ˆæˆæ¬Š Google ç›¸ç°¿');
                showPage('cloud');
                return;
            }
            
            showUploadProgress(`ä¸Šå‚³ä¸­ 0/${pending.length}`, 0);
            updateIsland('â˜ï¸', `ä¸Šå‚³ 0/${pending.length}`);
            document.getElementById('dynamicIsland').classList.add('uploading');
            
            let successCount = 0;
            
            for (let i = 0; i < pending.length; i++) {
                const photo = pending[i];
                const progress = Math.round(((i + 1) / pending.length) * 100);
                
                showUploadProgress(`ä¸Šå‚³ä¸­ ${i + 1}/${pending.length}`, progress);
                updateIsland('â˜ï¸', `ä¸Šå‚³ ${i + 1}/${pending.length}`);
                
                const result = await uploadToGooglePhotos(photo.data, photo.id);
                if (result.success) successCount++;
                
                await sleep(500); // é¿å… API é™åˆ¶
            }
            
            document.getElementById('dynamicIsland').classList.remove('uploading');
            updateIsland('ğŸ“·', 'AI æ‹ç«‹å¾— v3');
            
            showUploadProgress(`å®Œæˆï¼${successCount}/${pending.length}`, 100);
            showToast('âœ…', `å·²ä¸Šå‚³ ${successCount} å¼µç…§ç‰‡`);
            
            // ç™¼é€ LINE é€šçŸ¥
            if (lineNotifyEnabled && successCount > 0) {
                const timestamp = new Date().toLocaleString('zh-TW');
                await sendLineNotification(`ğŸ“· æ‰¹æ¬¡ä¸Šå‚³å®Œæˆï¼\n\nâœ… æˆåŠŸï¼š${successCount} å¼µ\nâ° æ™‚é–“ï¼š${timestamp}\nâ˜ï¸ å·²åŒæ­¥åˆ° Google ç›¸ç°¿\n\nâœ¨ AI æ‹ç«‹å¾— v3`);
            }
            
            await updateGallery();
            setTimeout(() => hideUploadProgress(), 2000);
        }

        function showUploadProgress(text, percent) {
            document.getElementById('uploadProgressText').textContent = text;
            document.getElementById('uploadProgressPercent').textContent = percent + '%';
            document.getElementById('uploadProgressFill').style.width = percent + '%';
            document.getElementById('uploadProgress').classList.add('active');
        }

        function hideUploadProgress() {
            document.getElementById('uploadProgress').classList.remove('active');
        }

        // ============================================
        // ç›¸æ©ŸåŠŸèƒ½
        // ============================================
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentCamera, width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: false
                });
                document.getElementById('cameraPreview').srcObject = stream;
                updateIsland('ğŸ“·', 'AI æ‹ç«‹å¾— v3');
            } catch (err) {
                console.error('ç›¸æ©ŸéŒ¯èª¤:', err);
                updateIsland('âš ï¸', 'ç„¡æ³•å­˜å–ç›¸æ©Ÿ');
                showToast('âŒ', 'ç„¡æ³•å­˜å–ç›¸æ©Ÿ');
            }
        }

        async function flipCamera() {
            currentCamera = currentCamera === 'user' ? 'environment' : 'user';
            if (stream) stream.getTracks().forEach(track => track.stop());
            await initCamera();
            showToast('ğŸ”„', currentCamera === 'user' ? 'å‰ç½®ç›¸æ©Ÿ' : 'å¾Œç½®ç›¸æ©Ÿ');
        }

        function toggleFlash() {
            flashEnabled = !flashEnabled;
            document.getElementById('flashBtn').classList.toggle('active', flashEnabled);
            showToast('âš¡', flashEnabled ? 'é–ƒå…‰ç‡ˆé–‹å•Ÿ' : 'é–ƒå…‰ç‡ˆé—œé–‰');
        }

        function toggleGrid() {
            gridEnabled = !gridEnabled;
            document.getElementById('gridOverlay').classList.toggle('active', gridEnabled);
            document.getElementById('gridBtn').classList.toggle('active', gridEnabled);
            document.getElementById('gridSwitch')?.classList.toggle('active', gridEnabled);
        }

        function cycleTimer() {
            const timers = [0, 3, 5, 10];
            const idx = timers.indexOf(timerSeconds);
            timerSeconds = timers[(idx + 1) % timers.length];
            document.getElementById('timerBtn').classList.toggle('active', timerSeconds > 0);
            showToast('â±', timerSeconds > 0 ? `${timerSeconds} ç§’å€’æ•¸` : 'å€’æ•¸é—œé–‰');
        }

        async function takePhoto() {
            if (timerSeconds > 0) {
                // å€’æ•¸è¨ˆæ™‚é‚è¼¯...
            }
            await capturePhoto();
        }

        async function capturePhoto() {
            if (flashEnabled) {
                document.getElementById('flashOverlay').classList.add('active');
                setTimeout(() => document.getElementById('flashOverlay').classList.remove('active'), 350);
            }
            if (soundEnabled) playShutterSound();
            
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            if (currentCamera === 'user') {
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
            }
            
            const filter = filters.find(f => f.id === currentFilter);
            if (filter && filter.css) ctx.filter = filter.css;
            ctx.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.85);
            
            // å„²å­˜åˆ° IndexedDB
            const photo = await savePhotoToDB(imageData);
            showToast('âœ…', 'ç…§ç‰‡å·²å„²å­˜');
            
            await updateGallery();
            updateLastPhotoThumb();
            
            // è‡ªå‹•ä¸Šå‚³
            if (autoUploadEnabled && isTokenValid()) {
                setTimeout(async () => {
                    const result = await uploadToGooglePhotos(imageData, photo.id);
                    if (result.success) {
                        showToast('â˜ï¸', 'å·²è‡ªå‹•ä¸Šå‚³');
                        if (lineNotifyEnabled) {
                            await sendLineNotification(`ğŸ“· æ–°ç…§ç‰‡å·²è‡ªå‹•ä¸Šå‚³ï¼\n\nâ° ${new Date().toLocaleString('zh-TW')}\nâ˜ï¸ å·²åŒæ­¥åˆ° Google ç›¸ç°¿`);
                        }
                        await updateGallery();
                    }
                }, 500);
            }
        }

        function playShutterSound() {
            const audio = new Audio('data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7v////////////////////////////////');
            audio.volume = 0.3;
            audio.play().catch(() => {});
        }

        // ============================================
        // UI åŠŸèƒ½
        // ============================================
        function initUI() {
            // æ¿¾é¡é¸æ“‡å™¨
            const filterInner = document.getElementById('filterStripInner');
            filters.forEach(f => {
                const item = document.createElement('div');
                item.className = `filter-item ${f.id === currentFilter ? 'active' : ''}`;
                item.dataset.filter = f.id;
                item.innerHTML = `<div class="filter-preview" style="filter:${f.css};background:linear-gradient(135deg,#667eea,#764ba2);"></div><span class="filter-name">${f.name}</span>`;
                item.onclick = () => selectFilter(f.id);
                filterInner.appendChild(item);
            });

            // ä¸»é¡Œé¸æ“‡å™¨
            const themeInner = document.getElementById('themeStripInner');
            themes.forEach(t => {
                const item = document.createElement('div');
                item.className = `theme-item ${t.id === currentTheme ? 'active' : ''}`;
                item.dataset.theme = t.id;
                item.innerHTML = `<div class="theme-preview ${t.id}"></div><span class="theme-name">${t.name}</span>`;
                item.onclick = () => selectTheme(t.id);
                themeInner.appendChild(item);
            });
        }

        function selectFilter(filterId) {
            currentFilter = filterId;
            document.querySelectorAll('.filter-item').forEach(el => {
                el.classList.toggle('active', el.dataset.filter === filterId);
            });
            const filter = filters.find(f => f.id === filterId);
            document.getElementById('cameraPreview').style.filter = filter ? filter.css : '';
        }

        function selectTheme(themeId) {
            currentTheme = themeId;
            document.body.className = `theme-${themeId}`;
            document.querySelectorAll('.theme-item').forEach(el => {
                el.classList.toggle('active', el.dataset.theme === themeId);
            });
            saveSettings();
            showToast('ğŸ¨', `å·²åˆ‡æ›è‡³ ${themes.find(t => t.id === themeId)?.name}`);
        }

        function setControlMode(mode) {
            controlMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            document.getElementById('filterStrip').classList.toggle('active', mode === 'filter');
            document.getElementById('themeStrip').classList.toggle('active', mode === 'theme');
        }

        async function updateGallery() {
            const photos = await getAllPhotos();
            const grid = document.getElementById('photoGrid');
            const empty = document.getElementById('photoEmpty');
            
            // æ›´æ–°çµ±è¨ˆ
            const uploadedCount = photos.filter(p => p.uploaded).length;
            document.getElementById('photoCount').textContent = photos.length;
            document.getElementById('uploadedCount').textContent = uploadedCount;
            document.getElementById('pendingCount').textContent = photos.length - uploadedCount;
            
            if (photos.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            grid.innerHTML = photos.map(photo => `
                <div class="photo-thumb" onclick="viewPhoto(${photo.id})">
                    <img src="${photo.data}" alt="Photo">
                    <span class="upload-badge">${photo.uploaded ? 'â˜ï¸' : 'ğŸ“±'}</span>
                </div>
            `).join('');
            
            // æ›´æ–°å„²å­˜ç©ºé–“
            const size = await calculateStorageSize();
            document.getElementById('storageSize').textContent = size;
        }

        async function updateLastPhotoThumb() {
            const photos = await getAllPhotos();
            const thumb = document.getElementById('lastPhotoThumb');
            if (photos.length > 0) {
                thumb.innerHTML = `<img src="${photos[0].data}" alt="Last">`;
            } else {
                thumb.innerHTML = 'ğŸ–¼ï¸';
            }
        }

        async function viewPhoto(id) {
            currentPhotoId = id;
            const photo = await getPhoto(id);
            if (!photo) return;
            
            document.getElementById('viewerImage').src = photo.data;
            document.getElementById('viewerUploadStatus').textContent = photo.uploaded ? 'â˜ï¸ å·²ä¸Šå‚³' : 'ğŸ“± æœ¬æ©Ÿ';
            document.getElementById('photoViewer').classList.add('active');
        }

        function closeViewer() {
            document.getElementById('photoViewer').classList.remove('active');
            currentPhotoId = null;
        }

        async function downloadCurrentPhoto() {
            if (!currentPhotoId) return;
            const photo = await getPhoto(currentPhotoId);
            if (!photo) return;
            
            const link = document.createElement('a');
            link.download = `polaroid_${Date.now()}.jpg`;
            link.href = photo.data;
            link.click();
            showToast('â¬‡ï¸', 'ç…§ç‰‡å·²ä¸‹è¼‰');
        }

        async function deleteCurrentPhoto() {
            if (!currentPhotoId) return;
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ')) return;
            
            await deletePhotoFromDB(currentPhotoId);
            closeViewer();
            await updateGallery();
            await updateLastPhotoThumb();
            showToast('ğŸ—‘ï¸', 'ç…§ç‰‡å·²åˆªé™¤');
        }

        async function clearAllPhotos() {
            const photos = await getAllPhotos();
            if (photos.length === 0) return;
            if (!confirm(`ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ ${photos.length} å¼µç…§ç‰‡å—ï¼Ÿ`)) return;
            
            await clearAllPhotosFromDB();
            await updateGallery();
            await updateLastPhotoThumb();
            showToast('ğŸ—‘ï¸', 'æ‰€æœ‰ç…§ç‰‡å·²æ¸…é™¤');
        }

        // ============================================
        // é é¢å°èˆª
        // ============================================
        function switchTab(tab) {
            document.querySelectorAll('.tab-item').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === tab);
            });
            if (tab === 'camera') {
                closePage('gallery');
                closePage('settings');
                closePage('cloud');
            } else if (tab === 'gallery') {
                showPage('gallery');
            } else if (tab === 'settings') {
                showPage('settings');
            } else if (tab === 'cloud') {
                showPage('cloud');
            }
        }

        function showPage(pageId) {
            document.getElementById(pageId + 'Page').classList.add('active');
        }

        function closePage(pageId) {
            document.getElementById(pageId + 'Page').classList.remove('active');
            document.querySelectorAll('.tab-item').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === 'camera');
            });
        }

        // ============================================
        // è¨­å®š
        // ============================================
        function toggleSetting(setting) {
            switch (setting) {
                case 'grid':
                    toggleGrid();
                    break;
                case 'sound':
                    soundEnabled = !soundEnabled;
                    document.getElementById('soundSwitch').classList.toggle('active', soundEnabled);
                    break;
                case 'autoUpload':
                    autoUploadEnabled = !autoUploadEnabled;
                    document.getElementById('autoUploadSwitch').classList.toggle('active', autoUploadEnabled);
                    break;
                case 'lineNotify':
                    lineNotifyEnabled = !lineNotifyEnabled;
                    document.getElementById('lineNotifySwitch').classList.toggle('active', lineNotifyEnabled);
                    break;
            }
            saveSettings();
        }

        function showAPIKeyInput() {
            const key = prompt('è«‹è¼¸å…¥ Gemini API Keyï¼š', geminiApiKey);
            if (key !== null) {
                geminiApiKey = key.trim();
                document.getElementById('apiStatus').textContent = geminiApiKey ? 'âœ“ å·²è¨­å®š' : 'æœªé€£æ¥';
                document.getElementById('apiStatus').style.color = geminiApiKey ? 'var(--ios-green)' : '';
                saveSettings();
            }
        }

        function saveSettings() {
            const settings = {
                currentTheme,
                soundEnabled,
                gridEnabled,
                geminiApiKey,
                autoUploadEnabled,
                lineNotifyEnabled
            };
            localStorage.setItem('polaroid_settings', JSON.stringify(settings));
        }

        function loadSettings() {
            try {
                const data = localStorage.getItem('polaroid_settings');
                if (data) {
                    const settings = JSON.parse(data);
                    currentTheme = settings.currentTheme || 'black-titanium';
                    soundEnabled = settings.soundEnabled !== false;
                    gridEnabled = settings.gridEnabled || false;
                    geminiApiKey = settings.geminiApiKey || '';
                    autoUploadEnabled = settings.autoUploadEnabled || false;
                    lineNotifyEnabled = settings.lineNotifyEnabled !== false;
                    
                    document.body.className = `theme-${currentTheme}`;
                    document.getElementById('soundSwitch')?.classList.toggle('active', soundEnabled);
                    document.getElementById('autoUploadSwitch')?.classList.toggle('active', autoUploadEnabled);
                    document.getElementById('lineNotifySwitch')?.classList.toggle('active', lineNotifyEnabled);
                    if (gridEnabled) toggleGrid();
                    if (geminiApiKey) {
                        document.getElementById('apiStatus').textContent = 'âœ“ å·²è¨­å®š';
                        document.getElementById('apiStatus').style.color = 'var(--ios-green)';
                    }
                }
            } catch (e) {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', e);
            }
        }

        function saveCloudSettings() {
            localStorage.setItem('googleClientId', document.getElementById('googleClientId').value);
            localStorage.setItem('lineGasUrl', document.getElementById('lineGasUrl').value);
            localStorage.setItem('lineGasSecret', document.getElementById('lineGasSecret').value);
            localStorage.setItem('lineToken', document.getElementById('lineToken').value);
            localStorage.setItem('lineUserId', document.getElementById('lineUserId').value);
            saveSettings();
            showToast('âœ…', 'é›²ç«¯è¨­å®šå·²å„²å­˜');
        }

        function loadCloudSettings() {
            document.getElementById('googleClientId').value = localStorage.getItem('googleClientId') || '';
            document.getElementById('lineGasUrl').value = localStorage.getItem('lineGasUrl') || '';
            document.getElementById('lineGasSecret').value = localStorage.getItem('lineGasSecret') || '';
            document.getElementById('lineToken').value = localStorage.getItem('lineToken') || '';
            document.getElementById('lineUserId').value = localStorage.getItem('lineUserId') || '';
            
            if (isTokenValid()) {
                updateAuthStatus('success', 'âœ… Google å·²æˆæ¬Š');
            }
        }

        // ============================================
        // UI è¼”åŠ©
        // ============================================
        function updateIsland(icon, text) {
            document.getElementById('islandText').textContent = text;
            document.querySelector('.island-icon').textContent = icon;
        }

        function showToast(icon, text) {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastText').textContent = text;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2200);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        // ============================================
        // é–‹æ©Ÿå‹•ç•«æ§åˆ¶
        // ============================================
        const bootSteps = [
            { progress: 15, status: 'æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«...' },
            { progress: 30, status: 'è¼‰å…¥ç›¸æ©Ÿæ¨¡çµ„...' },
            { progress: 50, status: 'æº–å‚™ä½¿ç”¨è€…ä»‹é¢...' },
            { progress: 70, status: 'è¼‰å…¥è¨­å®š...' },
            { progress: 85, status: 'é€£æ¥é›²ç«¯æœå‹™...' },
            { progress: 100, status: 'æº–å‚™å®Œæˆï¼' }
        ];
        
        async function runBootSequence() {
            const progressBar = document.getElementById('bootProgressBar');
            const statusText = document.getElementById('bootStatus');
            const bootScreen = document.getElementById('bootScreen');
            const appContainer = document.getElementById('appContainer');
            
            for (let i = 0; i < bootSteps.length; i++) {
                const step = bootSteps[i];
                progressBar.style.width = step.progress + '%';
                statusText.textContent = step.status;
                await new Promise(resolve => setTimeout(resolve, 400));
            }
            
            // å®Œæˆå¾Œç­‰å¾…ä¸€ä¸‹
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // éš±è—é–‹æ©Ÿç•«é¢ï¼Œé¡¯ç¤ºä¸»ç¨‹å¼
            bootScreen.classList.add('hidden');
            appContainer.classList.add('loaded');
            
            // å®Œå…¨ç§»é™¤é–‹æ©Ÿç•«é¢ï¼ˆç¯€çœè¨˜æ†¶é«”ï¼‰
            setTimeout(() => {
                bootScreen.remove();
            }, 1000);
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            // é–‹å§‹é–‹æ©Ÿå‹•ç•«
            const progressBar = document.getElementById('bootProgressBar');
            const statusText = document.getElementById('bootStatus');
            
            try {
                // Step 1: åˆå§‹åŒ–è³‡æ–™åº«
                progressBar.style.width = '15%';
                statusText.textContent = 'æ­£åœ¨åˆå§‹åŒ–è³‡æ–™åº«...';
                await initDB();
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Step 2: è¼‰å…¥ç›¸æ©Ÿ
                progressBar.style.width = '35%';
                statusText.textContent = 'è¼‰å…¥ç›¸æ©Ÿæ¨¡çµ„...';
                initCamera();
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // Step 3: æº–å‚™ UI
                progressBar.style.width = '55%';
                statusText.textContent = 'æº–å‚™ä½¿ç”¨è€…ä»‹é¢...';
                initUI();
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Step 4: è¼‰å…¥è¨­å®š
                progressBar.style.width = '70%';
                statusText.textContent = 'è¼‰å…¥ä½¿ç”¨è€…è¨­å®š...';
                loadSettings();
                loadCloudSettings();
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Step 5: è¼‰å…¥ç›¸ç°¿
                progressBar.style.width = '85%';
                statusText.textContent = 'è¼‰å…¥ç…§ç‰‡è³‡æ–™...';
                await updateGallery();
                await updateLastPhotoThumb();
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Step 6: å®Œæˆ
                progressBar.style.width = '100%';
                statusText.textContent = 'æº–å‚™å®Œæˆï¼';
                await new Promise(resolve => setTimeout(resolve, 600));
                
                // éš±è—é–‹æ©Ÿç•«é¢
                const bootScreen = document.getElementById('bootScreen');
                const appContainer = document.getElementById('appContainer');
                
                bootScreen.classList.add('hidden');
                appContainer.classList.add('loaded');
                
                // å®Œå…¨ç§»é™¤é–‹æ©Ÿç•«é¢
                setTimeout(() => {
                    bootScreen.remove();
                }, 1000);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                statusText.textContent = 'åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢';
                statusText.style.color = '#FF453A';
            }
        });
    </script>
</body>
</html>
