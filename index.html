<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AI æ‹ç«‹å¾—">
    <title>AI æ‹ç«‹å¾— v3</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        :root {
            --ios-blue: #007AFF; --ios-green: #34C759; --ios-red: #FF3B30; --ios-orange: #FF9500;
            --ios-yellow: #FFCC00; --ios-pink: #FF2D55; --ios-purple: #AF52DE; --ios-teal: #5AC8FA;
            --theme-primary: #1D1D1F; --theme-secondary: #2D2D2F; --theme-accent: #86868B;
            --theme-highlight: #0A84FF; --theme-glass: rgba(29, 29, 31, 0.85);
            --theme-glass-light: rgba(255, 255, 255, 0.1); --theme-border: rgba(255, 255, 255, 0.15);
            --theme-text: #FFFFFF; --theme-text-secondary: rgba(255, 255, 255, 0.6);
            --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px);
            --spring: cubic-bezier(0.175, 0.885, 0.32, 1.275); --ease-out: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --cam-body: #a8d8ea; --cam-body-dark: #8ec5d6;
        }
        .theme-black-titanium { --theme-primary: #1D1D1F; --theme-secondary: #2D2D2F; --theme-accent: #86868B; --theme-highlight: #0A84FF; --theme-glass: rgba(29, 29, 31, 0.9); --theme-border: rgba(255, 255, 255, 0.12); --theme-text: #FFFFFF; --theme-text-secondary: rgba(255, 255, 255, 0.6); --cam-body: #3A3A3C; --cam-body-dark: #2D2D2F; }
        .theme-white-titanium { --theme-primary: #F5F5F7; --theme-secondary: #E8E8ED; --theme-accent: #86868B; --theme-highlight: #0A84FF; --theme-glass: rgba(245, 245, 247, 0.9); --theme-border: rgba(0, 0, 0, 0.1); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --cam-body: #f5f5f5; --cam-body-dark: #e8e8e8; }
        .theme-natural-titanium { --theme-primary: #ADA99F; --theme-secondary: #C4C0B6; --theme-accent: #8E8B82; --theme-highlight: #0A84FF; --theme-glass: rgba(173, 169, 159, 0.9); --theme-border: rgba(0, 0, 0, 0.1); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --cam-body: #C4C0B6; --cam-body-dark: #ADA99F; }
        .theme-desert-titanium { --theme-primary: #BFB5A0; --theme-secondary: #D4C9B5; --theme-accent: #A39A87; --theme-highlight: #FF9500; --theme-glass: rgba(191, 181, 160, 0.9); --theme-border: rgba(0, 0, 0, 0.1); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --cam-body: #D4C9B5; --cam-body-dark: #BFB5A0; }
        .theme-blue-titanium { --theme-primary: #394867; --theme-secondary: #4A5568; --theme-accent: #6B7C93; --theme-highlight: #5AC8FA; --theme-glass: rgba(57, 72, 103, 0.9); --theme-border: rgba(255, 255, 255, 0.15); --theme-text: #FFFFFF; --theme-text-secondary: rgba(255, 255, 255, 0.6); --cam-body: #4A5568; --cam-body-dark: #394867; }
        .theme-pink { --theme-primary: #F9D5E5; --theme-secondary: #FCEAF0; --theme-accent: #E8A4C4; --theme-highlight: #FF2D55; --theme-glass: rgba(249, 213, 229, 0.9); --theme-border: rgba(0, 0, 0, 0.08); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --cam-body: #ffb6c1; --cam-body-dark: #ff9aa8; }
        .theme-mint { --theme-primary: #C8E6D5; --theme-secondary: #DFF0E8; --theme-accent: #7DC4A5; --theme-highlight: #34C759; --theme-glass: rgba(200, 230, 213, 0.9); --theme-border: rgba(0, 0, 0, 0.08); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --cam-body: #a8e6cf; --cam-body-dark: #8cd9b8; }
        .theme-sky { --theme-primary: #B8D4E8; --theme-secondary: #D0E4F0; --theme-accent: #6BAFCF; --theme-highlight: #5AC8FA; --theme-glass: rgba(184, 212, 232, 0.9); --theme-border: rgba(0, 0, 0, 0.08); --theme-text: #1D1D1F; --theme-text-secondary: rgba(0, 0, 0, 0.5); --cam-body: #a8d8ea; --cam-body-dark: #8ec5d6; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; user-select: none; }
        html, body { width: 100%; height: 100%; overflow: hidden; font-family: 'Noto Sans TC', -apple-system, sans-serif; background: var(--theme-primary); color: var(--theme-text); touch-action: manipulation; transition: background 0.5s, color 0.5s; }
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; position: relative; overflow: hidden; opacity: 0; transition: opacity 0.8s; }
        .app-container.loaded { opacity: 1; }

        /* é–‹æ©Ÿå‹•ç•« */
        .boot-screen { position: fixed; inset: 0; z-index: 99999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s, visibility 0.8s; }
        .boot-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .boot-logo { position: relative; width: 150px; height: 150px; margin-bottom: 35px; }
        .boot-ring { position: absolute; inset: 0; border-radius: 50%; border: 2px solid transparent; }
        .boot-ring-1 { border-top-color: #0A84FF; border-right-color: #0A84FF; animation: spin 2s linear infinite; }
        .boot-ring-2 { inset: 10px; border-bottom-color: #5E5CE6; border-left-color: #5E5CE6; animation: spin 2.5s linear infinite reverse; }
        .boot-ring-3 { inset: 20px; border-top-color: #FF9500; animation: spin 3s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .boot-camera { position: absolute; inset: 28px; display: flex; align-items: center; justify-content: center; }
        .boot-camera-body { width: 85px; height: 65px; background: linear-gradient(180deg, #a8d8ea 0%, #8ec5d6 100%); border-radius: 12px; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 25px rgba(0,0,0,0.4); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .boot-lens { width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(145deg, #1A1A1C, #0D0D0F); box-shadow: 0 3px 12px rgba(0,0,0,0.4); position: relative; }
        .boot-lens::before { content: ''; position: absolute; inset: 5px; border-radius: 50%; background: conic-gradient(from 0deg, #0A84FF, #5E5CE6, #AF52DE, #FF2D55, #FF9500, #34C759, #0A84FF); animation: spin 4s linear infinite; }
        .boot-lens::after { content: ''; position: absolute; inset: 10px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #2D2D2F, #0D0D0F); }
        .boot-flash { position: absolute; top: 5px; right: 7px; width: 12px; height: 8px; background: linear-gradient(145deg, #FFD60A, #FF9500); border-radius: 2px; }
        .boot-shutter { position: absolute; top: -7px; left: 10px; width: 13px; height: 13px; background: linear-gradient(145deg, #ff6b6b, #ee5a5a); border-radius: 50%; border: 2px solid #fff; }
        .boot-title { font-size: 26px; font-weight: 700; color: #fff; margin-bottom: 6px; opacity: 0; animation: fadeIn 1s 0.5s forwards; }
        .boot-subtitle { font-size: 12px; color: rgba(255,255,255,0.6); margin-bottom: 45px; opacity: 0; animation: fadeIn 1s 0.8s forwards; letter-spacing: 2px; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } from { opacity: 0; transform: translateY(10px); } }
        .boot-progress { width: 170px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; opacity: 0; animation: fadeIn 1s 1s forwards; }
        .boot-progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #0A84FF, #5E5CE6, #AF52DE); transition: width 0.3s; }
        .boot-status { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 14px; opacity: 0; animation: fadeIn 1s 1.2s forwards; }
        .boot-version { position: absolute; bottom: 35px; font-size: 10px; color: rgba(255,255,255,0.3); }

        /* ä¸»ä»‹é¢ */
        .status-bar { position: absolute; top: 0; left: 0; right: 0; height: calc(var(--safe-top) + 44px); padding-top: var(--safe-top); display: flex; align-items: center; justify-content: center; z-index: 100; pointer-events: none; }
        .dynamic-island { background: var(--theme-glass); backdrop-filter: blur(30px); padding: 8px 16px; border-radius: 22px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; box-shadow: 0 4px 20px rgba(0,0,0,0.25); pointer-events: auto; border: 1px solid var(--theme-border); }
        .island-icon { font-size: 15px; }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        /* ç›¸æ©Ÿé é¢ */
        .camera-page { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; padding-top: calc(var(--safe-top) + 50px); padding-bottom: calc(135px + var(--safe-bottom)); background: linear-gradient(180deg, var(--theme-primary) 0%, var(--theme-secondary) 100%); position: relative; overflow: hidden; }

        /* instax ç›¸æ©Ÿ */
        .camera-body { width: 250px; height: 325px; background: linear-gradient(180deg, var(--cam-body) 0%, var(--cam-body-dark) 100%); border-radius: 26px 26px 34px 34px; position: relative; box-shadow: 0 14px 45px rgba(0,0,0,0.3), inset 0 2px 0 rgba(255,255,255,0.4), inset 0 -4px 12px rgba(0,0,0,0.1); }
        .cam-flash { position: absolute; top: 16px; right: 25px; width: 40px; height: 26px; background: linear-gradient(180deg, #f8f9fa 0%, #e0e0e0 100%); border-radius: 5px; box-shadow: inset 0 2px 3px rgba(255,255,255,0.8), 0 2px 4px rgba(0,0,0,0.2); transition: box-shadow 0.15s; }
        .cam-viewfinder { position: absolute; top: 24px; left: 50%; transform: translateX(-50%); width: 18px; height: 18px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #555, #222); box-shadow: inset 0 1px 2px rgba(255,255,255,0.3); }
        .shutter-socket { position: absolute; top: 12px; left: 20px; width: 50px; height: 50px; background: linear-gradient(180deg, #e0e0e0 0%, #c0c0c0 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .shutter-btn { width: 38px; height: 38px; border-radius: 50%; border: none; background: radial-gradient(circle at 30% 30%, #ff6b6b, #ee5a5a); cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.3); transition: transform 0.08s; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .shutter-btn:active { transform: scale(0.85) translateY(2px); }
        .lens-mount { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 155px; height: 155px; background: linear-gradient(180deg, #2d3436 0%, #1a1a1a 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: inset 0 4px 10px rgba(255,255,255,0.1), 0 8px 22px rgba(0,0,0,0.3); }
        .lens-ring-outer { width: 130px; height: 130px; background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 50%, #1a1a1a 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; }
        .lens-text { position: absolute; width: 100%; height: 100%; }
        .lens-text svg { width: 100%; height: 100%; }
        .lens-text text { font-size: 6px; fill: rgba(255,255,255,0.35); letter-spacing: 0.8px; }
        .lens-glass { width: 78px; height: 78px; border-radius: 50%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); overflow: hidden; position: relative; box-shadow: inset 0 0 16px rgba(0,0,0,0.5); }
        .lens-glass video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .lens-glass-shine { position: absolute; top: 8px; left: 8px; width: 16px; height: 16px; background: radial-gradient(circle, rgba(255,255,255,0.35), transparent); border-radius: 50%; pointer-events: none; }
        .lens-tap-hint { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); color: #fff; font-size: 10px; opacity: 0; transition: opacity 0.3s; pointer-events: none; border-radius: 50%; }
        .lens-glass:not(:has(video[srcObject])) .lens-tap-hint,
        .lens-glass video:not([srcObject]) ~ .lens-tap-hint { opacity: 1; }
        .cam-brand { position: absolute; bottom: 26px; left: 50%; transform: translateX(-50%); text-align: center; }
        .cam-brand-name { font-family: 'Pacifico', cursive; font-size: 1.15em; color: #555; text-shadow: 0 1px 0 rgba(255,255,255,0.5); }
        .cam-brand-model { font-size: 0.5em; color: #777; letter-spacing: 2px; margin-top: 2px; }
        .film-counter { position: absolute; bottom: 20px; right: 20px; background: #333; color: #FFD60A; padding: 3px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; font-family: 'Courier New', monospace; }
        .cam-controls { position: absolute; bottom: -52px; left: 0; right: 0; display: flex; justify-content: center; gap: 16px; }
        .cam-ctrl-btn { width: 44px; height: 44px; background: var(--theme-glass); backdrop-filter: blur(20px); border: 1px solid var(--theme-border); border-radius: 50%; color: var(--theme-text); font-size: 17px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.1s; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .cam-ctrl-btn:active { transform: scale(0.88); background: var(--theme-highlight); }
        .cam-ctrl-btn.active { background: var(--theme-highlight); color: #fff; border-color: transparent; }

        /* èŠ±é‚Šé¸æ“‡å™¨ */
        .frame-selector { position: absolute; bottom: calc(85px + var(--safe-bottom)); left: 0; right: 0; padding: 10px 0; }
        .frame-selector-label { display: block; text-align: center; font-size: 11px; color: var(--theme-text-secondary); margin-bottom: 8px; }
        .frame-options { display: flex; justify-content: center; gap: 9px; flex-wrap: wrap; padding: 0 12px; }
        .frame-option { width: 38px; height: 38px; border-radius: 9px; cursor: pointer; border: 3px solid transparent; transition: all 0.1s; box-shadow: 0 2px 6px rgba(0,0,0,0.2); -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .frame-option:active { transform: scale(0.9); }
        .frame-option.selected { border-color: var(--theme-highlight); transform: scale(1.12); }
        .frame-option.frame-white { background: #fff; }
        .frame-option.frame-black { background: #1a1a1a; }
        .frame-option.frame-mint { background: #a8e6cf; }
        .frame-option.frame-pink { background: #ffb6c1; }
        .frame-option.frame-floral { background: linear-gradient(135deg, #ffefd5 25%, #ffe4e1 75%); }
        .frame-option.frame-plaid { background: repeating-linear-gradient(0deg, #b0c4de, #b0c4de 3px, #87ceeb 3px, #87ceeb 6px); }
        .frame-option.frame-gradient { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #a18cd1 100%); }

        /* åº•ç‰‡é€€å‡ºå‹•ç•« */
        .polaroid-film { position: fixed; bottom: calc(165px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(150%); width: 190px; background: white; border-radius: 3px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); z-index: 500; opacity: 0; transition: all 0.8s var(--spring); padding: 8px; }
        .polaroid-film.ejecting { transform: translateX(-50%) translateY(0); opacity: 1; }
        .polaroid-film.frame-black { background: #1a1a1a; }
        .polaroid-film.frame-mint { background: #a8e6cf; }
        .polaroid-film.frame-pink { background: #ffb6c1; }
        .polaroid-film.frame-floral { background: linear-gradient(135deg, #ffefd5 25%, #ffe4e1 75%); }
        .polaroid-film.frame-plaid { background: repeating-linear-gradient(0deg, #b0c4de, #b0c4de 4px, #87ceeb 4px, #87ceeb 8px); }
        .polaroid-film.frame-gradient { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #a18cd1 100%); }
        .polaroid-image-area { width: 100%; aspect-ratio: 1; background: #f5f5f5; overflow: hidden; position: relative; border-radius: 2px; }
        .polaroid-image-area img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 2s; }
        .polaroid-image-area img.developed { opacity: 1; }
        .polaroid-developing { position: absolute; inset: 0; background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(220,220,200,0.9) 100%); display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px; transition: opacity 2s; }
        .polaroid-developing.hidden { opacity: 0; pointer-events: none; }
        .polaroid-photo-text { padding: 5px 4px 9px; text-align: center; font-size: 10px; color: #666; font-style: italic; }
        .polaroid-film.frame-black .polaroid-photo-text { color: #aaa; }

        /* æ•£è½ç…§ç‰‡ï¼ˆå¯æ‹–æ›³ï¼‰*/
        .scattered-photos { position: absolute; inset: 0; pointer-events: none; overflow: hidden; z-index: 50; }
        .scattered-photo { position: absolute; width: 85px; background: white; border-radius: 3px; box-shadow: 0 4px 14px rgba(0,0,0,0.3); cursor: grab; pointer-events: auto; transition: box-shadow 0.2s; padding: 5px; touch-action: none; }
        .scattered-photo:hover { box-shadow: 0 8px 22px rgba(0,0,0,0.4); z-index: 100; }
        .scattered-photo.dragging { cursor: grabbing; box-shadow: 0 12px 30px rgba(0,0,0,0.5); z-index: 200; transform: scale(1.05); }
        .scattered-photo img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 2px; pointer-events: none; }
        .scattered-photo .photo-text { font-size: 7px; color: #999; text-align: center; padding: 3px 0; font-style: italic; pointer-events: none; }

        /* Tab Bar */
        .tab-bar { position: absolute; bottom: 0; left: 0; right: 0; height: calc(80px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); background: var(--theme-glass); backdrop-filter: blur(40px); border-top: 0.5px solid var(--theme-border); display: flex; justify-content: space-around; align-items: center; z-index: 200; }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px; background: transparent; border: none; color: var(--theme-text-secondary); cursor: pointer; transition: all 0.1s; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .tab-item:active { transform: scale(0.92); }
        .tab-item.active { color: var(--theme-highlight); }
        .tab-icon { font-size: 23px; }
        .tab-label { font-size: 10px; font-weight: 600; }

        /* é é¢è¦–åœ– */
        .page-view { position: absolute; inset: 0; background: var(--theme-primary); z-index: 300; transform: translateX(100%); transition: transform 0.4s var(--ease-out); display: flex; flex-direction: column; }
        .page-view.active { transform: translateX(0); }
        .page-header { height: calc(var(--safe-top) + 54px); padding-top: var(--safe-top); background: var(--theme-glass); backdrop-filter: blur(30px); border-bottom: 0.5px solid var(--theme-border); display: flex; align-items: center; justify-content: space-between; padding-left: 14px; padding-right: 14px; }
        .page-title { font-size: 16px; font-weight: 700; }
        .page-btn { padding: 8px 12px; background: transparent; border: none; color: var(--theme-highlight); font-size: 15px; cursor: pointer; font-weight: 500; }
        .page-content { flex: 1; overflow-y: auto; padding: 14px; padding-bottom: calc(14px + var(--safe-bottom)); }

        /* ç›¸ç°¿ */
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
        .photo-thumb { aspect-ratio: 1; background: var(--theme-secondary); cursor: pointer; overflow: hidden; position: relative; border-radius: 3px; }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.2s; }
        .photo-thumb:active img { transform: scale(1.05); }
        .photo-thumb .upload-badge { position: absolute; top: 4px; right: 4px; font-size: 11px; background: rgba(0,0,0,0.5); padding: 2px 5px; border-radius: 7px; }
        .photo-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 45px 18px; color: var(--theme-text-secondary); gap: 10px; }
        .photo-empty-icon { font-size: 52px; opacity: 0.5; }
        .storage-stats { background: var(--theme-glass); border-radius: 13px; padding: 13px; margin-bottom: 14px; }
        .storage-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--theme-border); font-size: 13px; }
        .storage-row:last-child { border-bottom: none; }
        .storage-label { color: var(--theme-text-secondary); }
        .storage-value { color: var(--theme-highlight); font-weight: 600; }

        /* ç…§ç‰‡æª¢è¦–å™¨ */
        .photo-viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 400; display: none; flex-direction: column; }
        .photo-viewer.active { display: flex; }
        .viewer-header { height: calc(var(--safe-top) + 54px); padding-top: var(--safe-top); display: flex; align-items: center; justify-content: space-between; padding: 0 14px; padding-top: var(--safe-top); }
        .viewer-content { flex: 1; display: flex; align-items: center; justify-content: center; padding: 14px; overflow: hidden; }
        .viewer-image { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 5px; }
        .viewer-actions { padding: 14px; padding-bottom: calc(14px + var(--safe-bottom)); display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .viewer-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; background: transparent; border: none; color: #fff; font-size: 10px; cursor: pointer; padding: 8px 12px; }
        .viewer-btn-icon { font-size: 22px; }
        .viewer-ai-result { position: absolute; bottom: 125px; left: 14px; right: 14px; background: var(--theme-glass); backdrop-filter: blur(20px); border-radius: 13px; padding: 13px; max-height: 150px; overflow-y: auto; display: none; }
        .viewer-ai-result.active { display: block; }
        .viewer-ai-result h4 { font-size: 12px; margin-bottom: 5px; color: var(--ios-purple); }
        .viewer-ai-result p { font-size: 11px; line-height: 1.5; color: #fff; }

        /* è¨­å®šé é¢ */
        .settings-section { background: var(--theme-glass); border-radius: 13px; margin-bottom: 14px; overflow: hidden; }
        .settings-header { padding: 11px 14px; font-size: 11px; font-weight: 600; color: var(--theme-text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 11px 14px; border-bottom: 0.5px solid var(--theme-border); }
        .settings-item:last-child { border-bottom: none; }
        .settings-label { display: flex; align-items: center; gap: 9px; flex: 1; }
        .settings-icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 15px; color: #fff; }
        .settings-text { display: flex; flex-direction: column; }
        .settings-text-main { font-size: 13px; }
        .settings-text-sub { font-size: 10px; color: var(--theme-text-secondary); }
        .settings-value { color: var(--theme-text-secondary); font-size: 13px; }
        .ios-switch { width: 46px; height: 28px; background: var(--theme-accent); border-radius: 14px; position: relative; cursor: pointer; transition: background 0.3s; flex-shrink: 0; }
        .ios-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; background: #fff; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .ios-switch.active { background: var(--ios-green); }
        .ios-switch.active::after { transform: translateX(18px); }
        .input-field { width: 100%; padding: 10px 12px; background: var(--theme-secondary); border: 1px solid var(--theme-border); border-radius: 9px; color: var(--theme-text); font-size: 13px; outline: none; transition: border-color 0.2s; }
        .input-field:focus { border-color: var(--theme-highlight); }
        .input-field::placeholder { color: var(--theme-text-secondary); }
        .btn { width: 100%; padding: 11px; background: var(--theme-highlight); color: #fff; border: none; border-radius: 9px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.15s; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .btn:active { transform: scale(0.97); opacity: 0.85; }
        .btn-sm { padding: 8px 12px; font-size: 12px; }
        .btn-outline { background: transparent; border: 1px solid var(--theme-border); color: var(--theme-text); }
        .btn-google { background: #4285F4; }
        .btn-line { background: #06C755; }
        .btn-danger { background: transparent; border: 1px solid var(--ios-red); color: var(--ios-red); }
        .btn-danger-outline { background: transparent; border: 1px solid var(--ios-red); color: var(--ios-red); }
        
        /* è¼¸å…¥æ¡†å¸¶é¡¯ç¤º/éš±è—åˆ‡æ› */
        .input-with-toggle { position: relative; display: flex; align-items: center; }
        .input-with-toggle .input-field { padding-right: 45px; }
        .toggle-visibility { position: absolute; right: 8px; background: none; border: none; font-size: 18px; cursor: pointer; padding: 8px; opacity: 0.6; transition: opacity 0.2s; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .toggle-visibility:active { opacity: 1; }
        .auth-status { padding: 9px 12px; border-radius: 9px; font-size: 12px; }
        .auth-status.success { background: rgba(52,199,89,0.2); color: var(--ios-green); }
        .auth-status.error { background: rgba(255,59,48,0.2); color: var(--ios-red); }

        /* ä¸»é¡Œé¸æ“‡å™¨ */
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 12px; }
        .theme-option { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; }
        .theme-preview { width: 42px; height: 42px; border-radius: 50%; border: 3px solid transparent; box-shadow: 0 2px 7px rgba(0,0,0,0.2); transition: all 0.2s; }
        .theme-option.active .theme-preview { border-color: var(--theme-highlight); transform: scale(1.1); }
        .theme-name { font-size: 9px; color: var(--theme-text-secondary); text-align: center; }
        .theme-preview.black-titanium { background: linear-gradient(145deg, #3A3A3C, #1D1D1F); }
        .theme-preview.white-titanium { background: linear-gradient(145deg, #FFFFFF, #E8E8ED); }
        .theme-preview.natural-titanium { background: linear-gradient(145deg, #C4C0B6, #ADA99F); }
        .theme-preview.desert-titanium { background: linear-gradient(145deg, #D4C9B5, #BFB5A0); }
        .theme-preview.blue-titanium { background: linear-gradient(145deg, #4A5568, #394867); }
        .theme-preview.pink { background: linear-gradient(145deg, #FCEAF0, #F9D5E5); }
        .theme-preview.mint { background: linear-gradient(145deg, #DFF0E8, #C8E6D5); }
        .theme-preview.sky { background: linear-gradient(145deg, #D0E4F0, #B8D4E8); }

        /* Toast & Flash */
        .flash-overlay { position: fixed; inset: 0; background: #fff; z-index: 600; opacity: 0; pointer-events: none; transition: opacity 0.1s; }
        .flash-overlay.active { opacity: 1; }
        .toast { position: fixed; bottom: calc(92px + var(--safe-bottom)); left: 50%; transform: translateX(-50%) translateY(20px); background: var(--theme-glass); backdrop-filter: blur(20px); padding: 9px 18px; border-radius: 22px; display: flex; align-items: center; gap: 7px; font-size: 13px; font-weight: 500; opacity: 0; transition: all 0.35s var(--spring); z-index: 500; pointer-events: none; border: 1px solid var(--theme-border); }
        .toast.active { opacity: 1; transform: translateX(-50%) translateY(0); }
        .upload-progress { position: fixed; bottom: calc(92px + var(--safe-bottom)); left: 14px; right: 14px; background: var(--theme-glass); backdrop-filter: blur(20px); padding: 12px; border-radius: 12px; z-index: 500; display: none; border: 1px solid var(--theme-border); font-size: 13px; }
        .upload-progress.active { display: block; }
        .progress-bar { height: 5px; background: var(--theme-secondary); border-radius: 3px; margin-top: 9px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--ios-blue), var(--ios-green)); transition: width 0.3s; }
    </style>
</head>
<body class="theme-sky">
    <!-- é–‹æ©Ÿå‹•ç•« -->
    <div class="boot-screen" id="bootScreen">
        <div class="boot-logo">
            <div class="boot-ring boot-ring-1"></div>
            <div class="boot-ring boot-ring-2"></div>
            <div class="boot-ring boot-ring-3"></div>
            <div class="boot-camera">
                <div class="boot-camera-body">
                    <div class="boot-shutter"></div>
                    <div class="boot-flash"></div>
                    <div class="boot-lens"></div>
                </div>
            </div>
        </div>
        <div class="boot-title">AI æ‹ç«‹å¾—</div>
        <div class="boot-subtitle">INSTAX CAMERA</div>
        <div class="boot-progress"><div class="boot-progress-bar" id="bootProgressBar"></div></div>
        <div class="boot-status" id="bootStatus">æ­£åœ¨åˆå§‹åŒ–...</div>
        <div class="boot-version">v3.0.0 â€¢ iPhone 17 Edition</div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="status-bar">
            <div class="dynamic-island" id="dynamicIsland">
                <span class="island-icon">ğŸ“·</span>
                <span id="islandText">AI æ‹ç«‹å¾— v3</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="camera-page" id="cameraPage">
                <div class="scattered-photos" id="scatteredPhotos"></div>
                
                <div class="camera-body" id="cameraBody" onclick="checkAndRestoreCamera()">
                    <div class="cam-flash" id="camFlash"></div>
                    <div class="cam-viewfinder"></div>
                    <div class="shutter-socket"><button class="shutter-btn" id="shutterBtn" ontouchstart="takePhoto()" onclick="takePhoto()"></button></div>
                    <div class="lens-mount">
                        <div class="lens-ring-outer">
                            <div class="lens-text">
                                <svg viewBox="0 0 200 200">
                                    <path id="lensCurve" d="M 100, 100 m -70, 0 a 70,70 0 1,1 140,0 a 70,70 0 1,1 -140,0" fill="none"/>
                                    <text><textPath href="#lensCurve">INSTAX LENS 60mm f/12.7 â€¢ AI POWERED</textPath></text>
                                </svg>
                            </div>
                            <div class="lens-glass" onclick="checkAndRestoreCamera(); event.stopPropagation();" style="cursor: pointer;">
                                <video id="cameraPreview" autoplay playsinline muted></video>
                                <div class="lens-glass-shine"></div>
                                <div class="lens-tap-hint" id="lensTapHint">é»æ“Šæ¢å¾©</div>
                            </div>
                        </div>
                    </div>
                    <div class="cam-brand">
                        <div class="cam-brand-name">instax</div>
                        <div class="cam-brand-model">mini AI</div>
                    </div>
                    <div class="film-counter" id="filmCounter">10</div>
                    <div class="cam-controls">
                        <button class="cam-ctrl-btn" id="flashBtn" ontouchstart="toggleFlash()" onclick="toggleFlash()">âš¡</button>
                        <button class="cam-ctrl-btn" id="timerBtn" ontouchstart="cycleTimer()" onclick="cycleTimer()">â±</button>
                        <button class="cam-ctrl-btn" id="flipBtn" ontouchstart="flipCamera()" onclick="flipCamera()">ğŸ”„</button>
                        <button class="cam-ctrl-btn" id="filterBtn" ontouchstart="cycleFilter()" onclick="cycleFilter()">ğŸ¨</button>
                    </div>
                </div>
                
                <div class="frame-selector">
                    <span class="frame-selector-label">ğŸ“· é¸æ“‡èŠ±é‚Šæ¨£å¼</span>
                    <div class="frame-options" id="frameOptions">
                        <div class="frame-option frame-white selected" data-frame="white" ontouchstart="selectFrame('white', this)" onclick="selectFrame('white', this)"></div>
                        <div class="frame-option frame-black" data-frame="black" ontouchstart="selectFrame('black', this)" onclick="selectFrame('black', this)"></div>
                        <div class="frame-option frame-mint" data-frame="mint" ontouchstart="selectFrame('mint', this)" onclick="selectFrame('mint', this)"></div>
                        <div class="frame-option frame-pink" data-frame="pink" ontouchstart="selectFrame('pink', this)" onclick="selectFrame('pink', this)"></div>
                        <div class="frame-option frame-floral" data-frame="floral" ontouchstart="selectFrame('floral', this)" onclick="selectFrame('floral', this)"></div>
                        <div class="frame-option frame-plaid" data-frame="plaid" ontouchstart="selectFrame('plaid', this)" onclick="selectFrame('plaid', this)"></div>
                        <div class="frame-option frame-gradient" data-frame="gradient" ontouchstart="selectFrame('gradient', this)" onclick="selectFrame('gradient', this)"></div>
                    </div>
                </div>
                
                <div class="polaroid-film frame-white" id="polaroidFilm">
                    <div class="polaroid-image-area">
                        <img id="filmImage" src="" alt="Photo">
                        <div class="polaroid-developing" id="filmDeveloping">æ²–æ´—ä¸­...</div>
                    </div>
                    <div class="polaroid-photo-text" id="filmText">Memories âœ¨</div>
                </div>
            </div>
        </div>
        
        <nav class="tab-bar">
            <button class="tab-item active" data-tab="camera" ontouchstart="switchTab('camera')" onclick="switchTab('camera')"><span class="tab-icon">ğŸ“·</span><span class="tab-label">ç›¸æ©Ÿ</span></button>
            <button class="tab-item" data-tab="gallery" ontouchstart="switchTab('gallery')" onclick="switchTab('gallery')"><span class="tab-icon">ğŸ–¼ï¸</span><span class="tab-label">ç›¸ç°¿</span></button>
            <button class="tab-item" data-tab="cloud" ontouchstart="switchTab('cloud')" onclick="switchTab('cloud')"><span class="tab-icon">â˜ï¸</span><span class="tab-label">é›²ç«¯</span></button>
            <button class="tab-item" data-tab="settings" ontouchstart="switchTab('settings')" onclick="switchTab('settings')"><span class="tab-icon">âš™ï¸</span><span class="tab-label">è¨­å®š</span></button>
        </nav>

        <!-- ç›¸ç°¿é é¢ -->
        <div class="page-view" id="galleryPage">
            <div class="page-header">
                <button class="page-btn" onclick="closePage('gallery')">â† è¿”å›</button>
                <span class="page-title">æˆ‘çš„ç…§ç‰‡</span>
                <button class="page-btn" onclick="clearAllPhotos()">æ¸…é™¤</button>
            </div>
            <div class="page-content">
                <div class="storage-stats">
                    <div class="storage-row"><span class="storage-label">ğŸ“· ç…§ç‰‡æ•¸é‡</span><span class="storage-value" id="photoCount">0</span></div>
                    <div class="storage-row"><span class="storage-label">â˜ï¸ å·²ä¸Šå‚³</span><span class="storage-value" id="uploadedCount">0</span></div>
                    <div class="storage-row"><span class="storage-label">â³ å¾…ä¸Šå‚³</span><span class="storage-value" id="pendingCount">0</span></div>
                </div>
                
                <!-- ä¸Šå‚³åˆ° Google ç›¸ç°¿ -->
                <div class="settings-section" style="margin-bottom: 14px;">
                    <div class="settings-header">â˜ï¸ ä¸Šå‚³åˆ° GOOGLE ç›¸ç°¿</div>
                    <div style="padding: 8px 14px 4px; font-size: 11px; color: var(--theme-text-secondary);">åƒ…ä¸Šå‚³ç…§ç‰‡ï¼Œä½œç‚ºé›²ç«¯å‚™ä»½ç´€å¿µ</div>
                    <div style="padding: 8px 14px 12px; display: flex; gap: 8px;">
                        <button class="btn btn-google" style="flex: 1;" ontouchstart="uploadAllPending()" onclick="uploadAllPending()">ğŸ“¤ ä¸Šå‚³ç…§ç‰‡</button>
                    </div>
                </div>
                
                <!-- åŒ¯å‡ºåˆ°æ–‡ä»¶ -->
                <div class="settings-section" style="margin-bottom: 14px;">
                    <div class="settings-header">ğŸ“„ åŒ¯å‡ºåˆ° GOOGLE æ–‡ä»¶</div>
                    <div style="padding: 8px 14px 4px; font-size: 11px; color: var(--theme-text-secondary);">åœ–æ–‡ä¸¦èŒ‚ï¼ŒåŒ…å«ç…§ç‰‡ + AI æè¿° + æ‹æ”è³‡è¨Š</div>
                    <div style="padding: 8px 14px 12px; display: flex; gap: 8px;">
                        <button class="btn" style="flex: 1; background: #4285F4;" ontouchstart="exportToGoogleDocs()" onclick="exportToGoogleDocs()">ğŸ“ åŒ¯å‡ºåœ–æ–‡ç›¸ç°¿</button>
                    </div>
                </div>
                
                <!-- æœ¬æ©Ÿä¸‹è¼‰ -->
                <div class="settings-section" style="margin-bottom: 14px;">
                    <div class="settings-header">ğŸ’¾ æœ¬æ©Ÿä¸‹è¼‰</div>
                    <div style="padding: 12px 14px; display: flex; gap: 8px;">
                        <button class="btn btn-outline" style="flex: 1;" ontouchstart="downloadAllPhotos()" onclick="downloadAllPhotos()">â¬‡ï¸ ä¸‹è¼‰å…¨éƒ¨ç…§ç‰‡</button>
                    </div>
                </div>
                
                <!-- é›²ç«¯æŸ¥é–± -->
                <div class="settings-section" style="margin-bottom: 14px;">
                    <div class="settings-header">ğŸ”— é›²ç«¯æŸ¥é–±</div>
                    <div style="padding: 12px 14px; display: flex; gap: 8px;">
                        <button class="btn btn-outline" style="flex: 1;" ontouchstart="openGooglePhotos()" onclick="openGooglePhotos()">ğŸ“· é–‹å•Ÿé›²ç«¯ç›¸ç°¿</button>
                        <button class="btn btn-outline" style="flex: 1;" ontouchstart="openGoogleDocs()" onclick="openGoogleDocs()">ğŸ“„ é–‹å•Ÿé›²ç«¯æ–‡ä»¶</button>
                    </div>
                </div>
                
                <div class="photo-grid" id="photoGrid"></div>
                <div class="photo-empty" id="photoEmpty">
                    <span class="photo-empty-icon">ğŸ“·</span>
                    <span>é‚„æ²’æœ‰ç…§ç‰‡</span>
                    <span style="font-size: 12px; opacity: 0.6;">æ‹æ”çš„ç…§ç‰‡æœƒé¡¯ç¤ºåœ¨é€™è£¡</span>
                </div>
            </div>
        </div>

        <!-- é›²ç«¯é é¢ -->
        <div class="page-view" id="cloudPage">
            <div class="page-header">
                <button class="page-btn" onclick="closePage('cloud')">â† è¿”å›</button>
                <span class="page-title">é›²ç«¯åŒæ­¥</span>
                <span></span>
            </div>
            <div class="page-content">
                <div class="settings-section">
                    <div class="settings-header">ğŸ“· Google æ•´åˆï¼ˆ24å°æ™‚æˆæ¬Šï¼‰</div>
                    <div style="padding: 8px 14px; font-size: 11px; color: var(--theme-text-secondary); background: var(--theme-secondary); margin: 0 14px 12px; border-radius: 8px;">
                        éœ€è¦çš„æ¬Šé™ï¼š<br>
                        âœ… Google ç›¸ç°¿ï¼ˆä¸Šå‚³ç…§ç‰‡ï¼‰<br>
                        âœ… Google Docsï¼ˆå»ºç«‹æ–‡ä»¶ï¼‰<br>
                        âœ… Google Driveï¼ˆåœ–ç‰‡æ’å…¥ Docsï¼‰<br><br>
                        âš ï¸ é¦–æ¬¡ä½¿ç”¨æˆ–æ¬Šé™ä¸è¶³è«‹é»ã€Œé‡æ–°æˆæ¬Šã€
                    </div>
                    
                    <!-- Google Client ID -->
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #4285F4;">G</div><span>Client ID</span></div></div>
                    <div style="padding: 0 14px 8px;">
                        <div class="input-with-toggle">
                            <input type="password" class="input-field" id="googleClientId" placeholder="è¼¸å…¥ Google OAuth Client ID">
                            <button class="toggle-visibility" ontouchstart="toggleFieldVisibility('googleClientId')" onclick="toggleFieldVisibility('googleClientId')">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div style="padding: 0 14px 12px; display: flex; gap: 8px;">
                        <button class="btn btn-sm" style="flex: 1;" ontouchstart="saveField('googleClientId')" onclick="saveField('googleClientId')">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-sm btn-danger-outline" style="flex: 1;" ontouchstart="clearField('googleClientId')" onclick="clearField('googleClientId')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    
                    <div id="googleAuthStatus" class="auth-status" style="display: none; margin: 0 14px 12px;"></div>
                    <div style="padding: 0 14px 12px; display: flex; gap: 8px;">
                        <button class="btn btn-google" style="flex: 1;" ontouchstart="authorizeGoogle()" onclick="authorizeGoogle()">ğŸ”‘ æˆæ¬Š</button>
                        <button class="btn btn-outline" style="flex: 1;" ontouchstart="reauthorizeGoogle()" onclick="reauthorizeGoogle()">ğŸ”„ é‡æ–°æˆæ¬Š</button>
                    </div>
                    <div style="padding: 0 14px 12px;">
                        <button class="btn btn-danger" ontouchstart="clearGoogleAuth()" onclick="clearGoogleAuth()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ Google æˆæ¬Š</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-header">ğŸ’¬ LINE é€šçŸ¥</div>
                    
                    <!-- GAS URL -->
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #06C755;">ğŸŒ</div><span>GAS URL</span></div></div>
                    <div style="padding: 0 14px 8px;">
                        <div class="input-with-toggle">
                            <input type="password" class="input-field" id="lineGasUrl" placeholder="Google Apps Script ç¶²å€">
                            <button class="toggle-visibility" ontouchstart="toggleFieldVisibility('lineGasUrl')" onclick="toggleFieldVisibility('lineGasUrl')">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div style="padding: 0 14px 12px; display: flex; gap: 8px;">
                        <button class="btn btn-sm" style="flex: 1;" ontouchstart="saveField('lineGasUrl')" onclick="saveField('lineGasUrl')">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-sm btn-danger-outline" style="flex: 1;" ontouchstart="clearField('lineGasUrl')" onclick="clearField('lineGasUrl')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    
                    <!-- GAS Secret -->
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #06C755;">ğŸ”</div><span>GAS Secret</span></div></div>
                    <div style="padding: 0 14px 8px;">
                        <div class="input-with-toggle">
                            <input type="password" class="input-field" id="lineGasSecret" placeholder="GAS é©—è­‰å¯†é‘°">
                            <button class="toggle-visibility" ontouchstart="toggleFieldVisibility('lineGasSecret')" onclick="toggleFieldVisibility('lineGasSecret')">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div style="padding: 0 14px 12px; display: flex; gap: 8px;">
                        <button class="btn btn-sm" style="flex: 1;" ontouchstart="saveField('lineGasSecret')" onclick="saveField('lineGasSecret')">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-sm btn-danger-outline" style="flex: 1;" ontouchstart="clearField('lineGasSecret')" onclick="clearField('lineGasSecret')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    
                    <!-- LINE Token -->
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #06C755;">ğŸ«</div><span>LINE Token</span></div></div>
                    <div style="padding: 0 14px 8px;">
                        <div class="input-with-toggle">
                            <input type="password" class="input-field" id="lineToken" placeholder="LINE Messaging API Token">
                            <button class="toggle-visibility" ontouchstart="toggleFieldVisibility('lineToken')" onclick="toggleFieldVisibility('lineToken')">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div style="padding: 0 14px 12px; display: flex; gap: 8px;">
                        <button class="btn btn-sm" style="flex: 1;" ontouchstart="saveField('lineToken')" onclick="saveField('lineToken')">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-sm btn-danger-outline" style="flex: 1;" ontouchstart="clearField('lineToken')" onclick="clearField('lineToken')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    
                    <!-- LINE User ID -->
                    <div class="settings-item"><div class="settings-label"><div class="settings-icon" style="background: #06C755;">ğŸ‘¤</div><span>LINE User ID</span></div></div>
                    <div style="padding: 0 14px 8px;">
                        <div class="input-with-toggle">
                            <input type="password" class="input-field" id="lineUserId" placeholder="ä½ çš„ LINE User ID">
                            <button class="toggle-visibility" ontouchstart="toggleFieldVisibility('lineUserId')" onclick="toggleFieldVisibility('lineUserId')">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div style="padding: 0 14px 12px; display: flex; gap: 8px;">
                        <button class="btn btn-sm" style="flex: 1;" ontouchstart="saveField('lineUserId')" onclick="saveField('lineUserId')">ğŸ’¾ å„²å­˜</button>
                        <button class="btn btn-sm btn-danger-outline" style="flex: 1;" ontouchstart="clearField('lineUserId')" onclick="clearField('lineUserId')">ğŸ—‘ï¸ æ¸…é™¤</button>
                    </div>
                    
                    <div id="lineStatus" class="auth-status" style="display: none; margin: 0 14px 12px;"></div>
                    <div style="padding: 0 14px 12px; display: flex; gap: 8px;">
                        <button class="btn btn-line" style="flex: 1;" ontouchstart="testLineNotification()" onclick="testLineNotification()">ğŸ“¤ æ¸¬è©¦é€šçŸ¥</button>
                    </div>
                    <div style="padding: 0 14px 12px;">
                        <button class="btn btn-danger" ontouchstart="clearAllLineSettings()" onclick="clearAllLineSettings()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ LINE è¨­å®š</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <div class="settings-header">âš™ï¸ ä¸Šå‚³è¨­å®š</div>
                    <div class="settings-item">
                        <div class="settings-label"><div class="settings-icon" style="background: var(--ios-green);">ğŸ“¤</div><span>æ‹ç…§å¾Œè‡ªå‹•ä¸Šå‚³</span></div>
                        <div class="ios-switch" id="autoUploadSwitch" ontouchstart="toggleSetting('autoUpload')" onclick="toggleSetting('autoUpload')"></div>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label"><div class="settings-icon" style="background: var(--ios-blue);">ğŸ’¬</div><span>ä¸Šå‚³å¾Œ LINE é€šçŸ¥</span></div>
                        <div class="ios-switch active" id="lineNotifySwitch" ontouchstart="toggleSetting('lineNotify')" onclick="toggleSetting('lineNotify')"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨­å®šé é¢ -->
        <div class="page-view" id="settingsPage">
            <div class="page-header">
                <button class="page-btn" onclick="closePage('settings')">â† è¿”å›</button>
                <span class="page-title">è¨­å®š</span>
                <span></span>
            </div>
            <div class="page-content">
                <div class="settings-section">
                    <div class="settings-header">ğŸ¨ iPhone 17 ä¸»é¡Œ</div>
                    <div class="theme-grid" id="themeGrid"></div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">ğŸ¤– AI è¨­å®š</div>
                    <div class="settings-item">
                        <div class="settings-label">
                            <div class="settings-icon" style="background: var(--ios-purple);">ğŸ”‘</div>
                            <div class="settings-text"><span class="settings-text-main">Gemini API Key</span><span class="settings-text-sub">ç”¨æ–¼ AI ç…§ç‰‡æè¿°</span></div>
                        </div>
                        <button class="page-btn" onclick="showAPIKeyInput()">è¨­å®š â†’</button>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label"><div class="settings-icon" style="background: var(--ios-green);">âœ“</div><span>API ç‹€æ…‹</span></div>
                        <span class="settings-value" id="apiStatus">æœªé€£æ¥</span>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">ğŸ“· ç›¸æ©Ÿè¨­å®š</div>
                    <div class="settings-item">
                        <div class="settings-label"><div class="settings-icon" style="background: var(--ios-orange);">ğŸ”Š</div><span>å¿«é–€è²éŸ³</span></div>
                        <div class="ios-switch active" id="soundSwitch" onclick="toggleSetting('sound')"></div>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">ğŸ’¾ å„²å­˜ç©ºé–“</div>
                    <div class="settings-item">
                        <div class="settings-label"><div class="settings-icon" style="background: var(--ios-teal);">ğŸ’¾</div><span>å„²å­˜æ–¹å¼</span></div>
                        <span class="settings-value">IndexedDB</span>
                    </div>
                    <div class="settings-item">
                        <div class="settings-label"><div class="settings-icon" style="background: var(--ios-orange);">ğŸ“Š</div><span>ç…§ç‰‡å®¹é‡</span></div>
                        <span class="settings-value" id="storageSize">è¨ˆç®—ä¸­...</span>
                    </div>
                </div>
                <div class="settings-section">
                    <div class="settings-header">é—œæ–¼</div>
                    <div class="settings-item">
                        <div class="settings-label"><div class="settings-icon" style="background: var(--ios-teal);">â„¹ï¸</div><span>ç‰ˆæœ¬</span></div>
                        <span class="settings-value">3.0.0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç…§ç‰‡æª¢è¦–å™¨ -->
    <div class="photo-viewer" id="photoViewer">
        <div class="viewer-header">
            <button class="page-btn" onclick="closeViewer()">âœ• é—œé–‰</button>
            <span id="viewerUploadStatus"></span>
        </div>
        <div class="viewer-content"><img class="viewer-image" id="viewerImage" src="" alt="Photo"></div>
        <div class="viewer-ai-result" id="viewerAiResult"><h4>ğŸ¤– AI æè¿°</h4><p id="viewerAiText"></p></div>
        <div class="viewer-actions">
            <button class="viewer-btn" onclick="analyzeWithAI()"><span class="viewer-btn-icon">ğŸ¤–</span><span>AI åˆ†æ</span></button>
            <button class="viewer-btn" onclick="downloadCurrentPhoto()"><span class="viewer-btn-icon">â¬‡ï¸</span><span>ä¸‹è¼‰</span></button>
            <button class="viewer-btn" onclick="uploadCurrentPhoto()"><span class="viewer-btn-icon">â˜ï¸</span><span>ä¸Šå‚³</span></button>
            <button class="viewer-btn" onclick="deleteCurrentPhoto()" style="color: var(--ios-red);"><span class="viewer-btn-icon">ğŸ—‘ï¸</span><span>åˆªé™¤</span></button>
        </div>
    </div>

    <div class="upload-progress" id="uploadProgress">
        <div style="display: flex; justify-content: space-between;"><span id="uploadProgressText">ä¸Šå‚³ä¸­...</span><span id="uploadProgressPercent">0%</span></div>
        <div class="progress-bar"><div class="progress-fill" id="uploadProgressFill" style="width: 0%;"></div></div>
    </div>
    <div class="flash-overlay" id="flashOverlay"></div>
    <div class="toast" id="toast"><span id="toastIcon">âœ“</span><span id="toastText">å·²å„²å­˜</span></div>

    <script>
        let db = null;
        const DB_NAME = 'AIPolaroidDB', DB_VERSION = 2, STORE_NAME = 'photos';
        let stream = null, currentCamera = 'user';
        let currentFilter = 'none', currentFrame = 'white', currentTheme = 'sky';
        let timerSeconds = 0, filmCount = 10;
        let flashEnabled = false, soundEnabled = true;
        let autoUploadEnabled = false, lineNotifyEnabled = true;
        let geminiApiKey = '', currentPhotoId = null;
        const SCOPES = 'https://www.googleapis.com/auth/photoslibrary.appendonly https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file';
        const TOKEN_KEY = 'polaroid_google_token';
        let tokenClient = null;
        
        // é˜²æ­¢æŒ‰éˆ•é‡è¤‡è§¸ç™¼
        let lastTouchTime = 0;
        function preventDoubleTap(callback) {
            const now = Date.now();
            if (now - lastTouchTime < 300) return;
            lastTouchTime = now;
            callback();
        }
        
        const filters = [
            { id: 'none', name: 'åŸå§‹', css: '' },
            { id: 'vintage', name: 'å¾©å¤', css: 'sepia(0.4) contrast(1.1) brightness(1.05)' },
            { id: 'bw', name: 'é»‘ç™½', css: 'grayscale(1) contrast(1.1)' },
            { id: 'warm', name: 'æš–è‰²', css: 'sepia(0.2) saturate(1.3) brightness(1.05)' },
            { id: 'cool', name: 'å†·è‰²', css: 'saturate(0.9) brightness(1.1) hue-rotate(10deg)' },
            { id: 'vivid', name: 'é®®è±”', css: 'contrast(1.1) saturate(1.5) brightness(1.05)' }
        ];
        const frames = { white: { class: 'frame-white', textColor: '#666' }, black: { class: 'frame-black', textColor: '#aaa' }, mint: { class: 'frame-mint', textColor: '#2d5a45' }, pink: { class: 'frame-pink', textColor: '#8b4557' }, floral: { class: 'frame-floral', textColor: '#8b6914' }, plaid: { class: 'frame-plaid', textColor: '#1e3a5f' }, gradient: { class: 'frame-gradient', textColor: '#5a3d7a' } };
        const themes = [ { id: 'black-titanium', name: 'é»‘éˆ¦' }, { id: 'white-titanium', name: 'ç™½éˆ¦' }, { id: 'natural-titanium', name: 'åŸè‰²éˆ¦' }, { id: 'desert-titanium', name: 'æ²™æ¼ éˆ¦' }, { id: 'blue-titanium', name: 'è—éˆ¦' }, { id: 'pink', name: 'ç²‰ç´…' }, { id: 'mint', name: 'è–„è·' }, { id: 'sky', name: 'å¤©è—' } ];

        // IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(STORE_NAME)) {
                        const store = database.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp');
                        store.createIndex('uploaded', 'uploaded');
                    }
                };
            });
        }
        async function savePhotoToDB(photoData, frameType) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const photo = { id: Date.now(), data: photoData, timestamp: new Date().toISOString(), filter: currentFilter, frame: frameType || currentFrame, uploaded: false, googlePhotoId: null, aiDescription: null };
                const req = store.add(photo);
                req.onsuccess = () => resolve(photo);
                req.onerror = () => reject(req.error);
            });
        }
        async function getAllPhotos() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const req = tx.objectStore(STORE_NAME).getAll();
                req.onsuccess = () => resolve(req.result.sort((a, b) => b.id - a.id));
                req.onerror = () => reject(req.error);
            });
        }
        async function getPhoto(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readonly');
                const req = tx.objectStore(STORE_NAME).get(id);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        async function updatePhoto(id, updates) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const getReq = store.get(id);
                getReq.onsuccess = () => {
                    const photo = { ...getReq.result, ...updates };
                    const putReq = store.put(photo);
                    putReq.onsuccess = () => resolve(photo);
                    putReq.onerror = () => reject(putReq.error);
                };
            });
        }
        async function deletePhotoFromDB(id) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const req = tx.objectStore(STORE_NAME).delete(id);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        }
        async function clearAllPhotosFromDB() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([STORE_NAME], 'readwrite');
                const req = tx.objectStore(STORE_NAME).clear();
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        }

        // Google OAuth
        function isTokenValid() {
            const tokenData = localStorage.getItem(TOKEN_KEY);
            if (!tokenData) return false;
            const { expiry } = JSON.parse(tokenData);
            return expiry && Date.now() < expiry;
        }
        function getAccessToken() {
            const tokenData = localStorage.getItem(TOKEN_KEY);
            return tokenData ? JSON.parse(tokenData).access_token : null;
        }
        function saveGoogleToken(response) {
            localStorage.setItem(TOKEN_KEY, JSON.stringify({ access_token: response.access_token, expiry: Date.now() + 24 * 60 * 60 * 1000 }));
        }
        function initTokenClient() {
            const clientId = document.getElementById('googleClientId').value.trim();
            if (!clientId) { showToast('âš ï¸', 'è«‹å…ˆè¼¸å…¥ Client ID'); return false; }
            if (typeof google === 'undefined' || !google.accounts) { showToast('âŒ', 'Google API å°šæœªè¼‰å…¥'); return false; }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error) { showToast('âŒ', 'æˆæ¬Šå¤±æ•—'); updateAuthStatus('error', 'âŒ æˆæ¬Šå¤±æ•—'); return; }
                    saveGoogleToken(response);
                    updateAuthStatus('success', 'âœ… å·²æˆæ¬Šï¼ˆ24å°æ™‚æœ‰æ•ˆï¼‰');
                    showToast('âœ…', 'Google æˆæ¬ŠæˆåŠŸï¼');
                    saveGoogleSettings();
                }
            });
            return true;
        }
        function authorizeGoogle() {
            if (isTokenValid()) { showToast('âœ…', 'æˆæ¬Šä»æœ‰æ•ˆ'); updateAuthStatus('success', 'âœ… å·²æˆæ¬Šï¼ˆ24å°æ™‚æœ‰æ•ˆï¼‰'); return; }
            if (!initTokenClient()) return;
            tokenClient.requestAccessToken({ prompt: '' });
        }
        function reauthorizeGoogle() {
            if (!confirm('ç¢ºå®šè¦é‡æ–°æˆæ¬Šå—ï¼Ÿ')) return;
            localStorage.removeItem(TOKEN_KEY);
            if (!initTokenClient()) return;
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        function updateAuthStatus(type, message) {
            const el = document.getElementById('googleAuthStatus');
            el.style.display = 'block';
            el.className = `auth-status ${type}`;
            el.textContent = message;
        }
        function clearGoogleAuth() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ Google æˆæ¬Šï¼Ÿ')) return;
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem('polaroid_google');
            document.getElementById('googleClientId').value = '';
            document.getElementById('googleAuthStatus').style.display = 'none';
            showToast('ğŸ—‘ï¸', 'Google æˆæ¬Šå·²æ¸…é™¤');
        }
        
        // é–‹å•Ÿ Google ç›¸ç°¿
        function openGooglePhotos() {
            window.open('https://photos.google.com/', '_blank');
        }
        
        // é–‹å•Ÿ Google Docsï¼ˆåˆ—å‡ºæœ€è¿‘çš„æ–‡ä»¶ï¼‰
        function openGoogleDocs() {
            window.open('https://docs.google.com/document/u/0/', '_blank');
        }
        
        // æ¬„ä½ç¨ç«‹å„²å­˜
        function saveField(fieldId) {
            const value = document.getElementById(fieldId).value.trim();
            const fieldSettings = JSON.parse(localStorage.getItem('polaroid_fields') || '{}');
            fieldSettings[fieldId] = value;
            localStorage.setItem('polaroid_fields', JSON.stringify(fieldSettings));
            showToast('ğŸ’¾', 'å·²å„²å­˜');
        }
        
        // æ¬„ä½ç¨ç«‹æ¸…é™¤
        function clearField(fieldId) {
            document.getElementById(fieldId).value = '';
            const fieldSettings = JSON.parse(localStorage.getItem('polaroid_fields') || '{}');
            delete fieldSettings[fieldId];
            localStorage.setItem('polaroid_fields', JSON.stringify(fieldSettings));
            showToast('ğŸ—‘ï¸', 'å·²æ¸…é™¤');
        }
        
        // éš±ç¢¼åˆ‡æ›
        function toggleFieldVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            if (field.type === 'password') {
                field.type = 'text';
            } else {
                field.type = 'password';
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰ LINE è¨­å®š
        function clearAllLineSettings() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ LINE è¨­å®šï¼Ÿ')) return;
            const fields = ['lineGasUrl', 'lineGasSecret', 'lineToken', 'lineUserId'];
            fields.forEach(f => {
                document.getElementById(f).value = '';
            });
            localStorage.removeItem('polaroid_line');
            const fieldSettings = JSON.parse(localStorage.getItem('polaroid_fields') || '{}');
            fields.forEach(f => delete fieldSettings[f]);
            localStorage.setItem('polaroid_fields', JSON.stringify(fieldSettings));
            document.getElementById('lineStatus').style.display = 'none';
            showToast('ğŸ—‘ï¸', 'LINE è¨­å®šå·²å…¨éƒ¨æ¸…é™¤');
        }
        
        // è¼‰å…¥æ¬„ä½è¨­å®š
        function loadFieldSettings() {
            const fieldSettings = JSON.parse(localStorage.getItem('polaroid_fields') || '{}');
            Object.keys(fieldSettings).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = fieldSettings[fieldId];
                }
            });
        }

        // Google Photos Upload
        async function uploadToGooglePhotos(photoData, photoId) {
            if (!isTokenValid()) { showToast('âš ï¸', 'è«‹å…ˆæˆæ¬Š Google'); return { success: false }; }
            const token = getAccessToken();
            try {
                updateIsland('â˜ï¸', 'ä¸Šå‚³ä¸­...');
                const base64Data = photoData.split(',')[1];
                const byteArray = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
                const uploadRes = await fetch('https://photoslibrary.googleapis.com/v1/uploads', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/octet-stream', 'X-Goog-Upload-Content-Type': 'image/jpeg', 'X-Goog-Upload-Protocol': 'raw' },
                    body: byteArray
                });
                if (!uploadRes.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
                const uploadToken = await uploadRes.text();
                const createRes = await fetch('https://photoslibrary.googleapis.com/v1/mediaItems:batchCreate', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newMediaItems: [{ description: 'AI æ‹ç«‹å¾—', simpleMediaItem: { uploadToken } }] })
                });
                if (!createRes.ok) throw new Error('å»ºç«‹å¤±æ•—');
                const result = await createRes.json();
                if (result.newMediaItemResults?.[0]?.status?.message === 'Success') {
                    await updatePhoto(photoId, { uploaded: true, googlePhotoId: result.newMediaItemResults[0].mediaItem.id });
                    updateIsland('ğŸ“·', 'AI æ‹ç«‹å¾— v3');
                    return { success: true };
                }
                throw new Error('ä¸Šå‚³å¤±æ•—');
            } catch (error) {
                console.error('ä¸Šå‚³éŒ¯èª¤:', error);
                updateIsland('ğŸ“·', 'AI æ‹ç«‹å¾— v3');
                showToast('âŒ', error.message);
                return { success: false, error: error.message };
            }
        }

        // Google Docs Export with Images
        async function exportToGoogleDocs() {
            const photos = await getAllPhotos();
            if (photos.length === 0) { showToast('ğŸ“·', 'æ²’æœ‰ç…§ç‰‡å¯åŒ¯å‡º'); return; }
            
            if (!isTokenValid()) { 
                showToast('âš ï¸', 'è«‹å…ˆæˆæ¬Š Googleï¼ˆéœ€é‡æ–°æˆæ¬Šï¼‰'); 
                alert('åŒ¯å‡º Google Docs éœ€è¦é¡å¤–æ¬Šé™ã€‚\n\nè«‹åˆ°ã€Œé›²ç«¯ã€é é¢é»æ“Šã€Œé‡æ–°æˆæ¬Šã€æŒ‰éˆ•ã€‚');
                showPage('cloud'); 
                return; 
            }
            
            const token = getAccessToken();
            updateIsland('ğŸ“„', 'åŒ¯å‡ºä¸­...');
            showUploadProgress('æº–å‚™åŒ¯å‡º...', 0);
            
            try {
                // 1. å»ºç«‹ Google Doc
                showUploadProgress('å»ºç«‹æ–‡ä»¶...', 5);
                const createRes = await fetch('https://docs.googleapis.com/v1/documents', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: `ğŸ“· AI æ‹ç«‹å¾—ç›¸ç°¿ - ${new Date().toLocaleDateString('zh-TW')}` })
                });
                
                if (createRes.status === 403 || createRes.status === 401) {
                    throw new Error('ç¼ºå°‘æ¬Šé™ï¼Œè«‹é‡æ–°æˆæ¬Š');
                }
                if (!createRes.ok) throw new Error('å»ºç«‹æ–‡ä»¶å¤±æ•—');
                
                const doc = await createRes.json();
                const docId = doc.documentId;
                
                // 2. æº–å‚™æ’å…¥å…§å®¹çš„ requests
                let requests = [];
                let currentIndex = 1;
                
                // æ¨™é¡Œ
                const header = `ğŸ“· AI æ‹ç«‹å¾—ç›¸ç°¿\n\nåŒ¯å‡ºæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}\nç…§ç‰‡æ•¸é‡ï¼š${photos.length} å¼µ\n\n${'â”€'.repeat(40)}\n\n`;
                requests.push({
                    insertText: { location: { index: currentIndex }, text: header }
                });
                currentIndex += header.length;
                
                // 3. é€å¼µè™•ç†ç…§ç‰‡
                for (let i = 0; i < photos.length; i++) {
                    const photo = photos[i];
                    const progress = 10 + (i / photos.length) * 80;
                    showUploadProgress(`è™•ç†ç…§ç‰‡ ${i + 1}/${photos.length}...`, progress);
                    
                    // ä¸Šå‚³åœ–ç‰‡åˆ° Google Drive
                    const imageUrl = await uploadImageToDrive(photo.data, token, `photo_${i + 1}.jpg`);
                    
                    if (imageUrl) {
                        // æ’å…¥åœ–ç‰‡
                        requests.push({
                            insertInlineImage: {
                                location: { index: currentIndex },
                                uri: imageUrl,
                                objectSize: {
                                    height: { magnitude: 200, unit: 'PT' },
                                    width: { magnitude: 200, unit: 'PT' }
                                }
                            }
                        });
                        currentIndex += 1; // åœ–ç‰‡ä½” 1 å€‹å­—å…ƒä½ç½®
                    }
                    
                    // ç…§ç‰‡è³‡è¨Šæ–‡å­—
                    let photoInfo = `\n\nğŸ“¸ ç…§ç‰‡ ${i + 1}\n`;
                    photoInfo += `â° æ™‚é–“ï¼š${new Date(photo.timestamp).toLocaleString('zh-TW')}\n`;
                    photoInfo += `ğŸ¨ æ¿¾é¡ï¼š${filters.find(f => f.id === photo.filter)?.name || 'åŸå§‹'}\n`;
                    photoInfo += `ğŸ–¼ï¸ èŠ±é‚Šï¼š${photo.frame || 'white'}\n`;
                    photoInfo += `â˜ï¸ ç‹€æ…‹ï¼š${photo.uploaded ? 'å·²ä¸Šå‚³é›²ç«¯' : 'æœ¬æ©Ÿå„²å­˜'}\n`;
                    
                    if (photo.aiDescription) {
                        photoInfo += `\nğŸ¤– AI æè¿°ï¼š\n${photo.aiDescription}\n`;
                    }
                    
                    photoInfo += `\n${'â”€'.repeat(40)}\n\n`;
                    
                    requests.push({
                        insertText: { location: { index: currentIndex }, text: photoInfo }
                    });
                    currentIndex += photoInfo.length;
                    
                    // çŸ­æš«å»¶é²é¿å… API é™åˆ¶
                    await new Promise(r => setTimeout(r, 300));
                }
                
                // 4. æ‰¹æ¬¡æ›´æ–°æ–‡ä»¶
                showUploadProgress('å¯«å…¥æ–‡ä»¶...', 95);
                const updateRes = await fetch(`https://docs.googleapis.com/v1/documents/${docId}:batchUpdate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requests })
                });
                
                if (!updateRes.ok) {
                    const errorData = await updateRes.json().catch(() => ({}));
                    console.error('Update error:', errorData);
                    throw new Error('æ›´æ–°æ–‡ä»¶å¤±æ•—');
                }
                
                hideUploadProgress();
                updateIsland('ğŸ“·', 'AI æ‹ç«‹å¾— v3');
                showToast('âœ…', 'å·²åŒ¯å‡ºåˆ° Google Docsï¼ˆå«åœ–ç‰‡ï¼‰');
                
                // é–‹å•Ÿæ–‡ä»¶
                window.open(`https://docs.google.com/document/d/${docId}/edit`, '_blank');
                
            } catch (error) {
                console.error('åŒ¯å‡ºéŒ¯èª¤:', error);
                hideUploadProgress();
                updateIsland('ğŸ“·', 'AI æ‹ç«‹å¾— v3');
                showToast('âŒ', 'åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
                alert(`åŒ¯å‡ºå¤±æ•—ï¼š${error.message}\n\nè«‹ç¢ºèªï¼š\n1. å·²å•Ÿç”¨ Google Docs API\n2. å·²å•Ÿç”¨ Google Drive API\n3. é»æ“Šã€Œé‡æ–°æˆæ¬Šã€å–å¾—æ‰€æœ‰æ¬Šé™`);
            }
        }
        
        // ä¸Šå‚³åœ–ç‰‡åˆ° Google Drive ä¸¦å–å¾—å…¬é–‹ URL
        async function uploadImageToDrive(base64Data, token, fileName) {
            try {
                // è½‰æ› base64 ç‚º blob
                const base64 = base64Data.split(',')[1];
                const byteCharacters = atob(base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'image/jpeg' });
                
                // å»ºç«‹ multipart form data
                const metadata = {
                    name: fileName,
                    mimeType: 'image/jpeg'
                };
                
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);
                
                // ä¸Šå‚³åˆ° Drive
                const uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: form
                });
                
                if (!uploadRes.ok) {
                    console.error('Drive upload failed:', await uploadRes.text());
                    return null;
                }
                
                const file = await uploadRes.json();
                
                // è¨­å®šç‚ºä»»ä½•äººå¯è®€
                await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}/permissions`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        role: 'reader',
                        type: 'anyone'
                    })
                });
                
                // å›å‚³å¯ç”¨æ–¼ Docs çš„åœ–ç‰‡ URL
                return `https://drive.google.com/uc?id=${file.id}`;
                
            } catch (error) {
                console.error('ä¸Šå‚³åœ–ç‰‡å¤±æ•—:', error);
                return null;
            }
        }
        
        // ä¸‹è¼‰æ‰€æœ‰ç…§ç‰‡
        async function downloadAllPhotos() {
            const photos = await getAllPhotos();
            if (photos.length === 0) { 
                showToast('ğŸ“·', 'æ²’æœ‰ç…§ç‰‡å¯ä¸‹è¼‰'); 
                return; 
            }
            
            if (photos.length > 10) {
                if (!confirm(`å…± ${photos.length} å¼µç…§ç‰‡ï¼Œå°‡é€ä¸€ä¸‹è¼‰ã€‚\nç¹¼çºŒå—ï¼Ÿ`)) return;
            }
            
            updateIsland('ğŸ’¾', 'ä¸‹è¼‰ä¸­...');
            showToast('ğŸ’¾', `é–‹å§‹ä¸‹è¼‰ ${photos.length} å¼µç…§ç‰‡...`);
            
            for (let i = 0; i < photos.length; i++) {
                const photo = photos[i];
                const link = document.createElement('a');
                const timestamp = new Date(photo.timestamp).toISOString().slice(0, 10);
                link.download = `polaroid_${timestamp}_${i + 1}.jpg`;
                link.href = photo.data;
                link.click();
                
                // é–“éš”ä¸‹è¼‰é¿å…ç€è¦½å™¨é˜»æ“‹
                await new Promise(r => setTimeout(r, 500));
            }
            
            updateIsland('ğŸ“·', 'AI æ‹ç«‹å¾— v3');
            showToast('âœ…', `å·²ä¸‹è¼‰ ${photos.length} å¼µç…§ç‰‡`);
        }

        // LINE Notification
        async function sendLineNotification(message) {
            const gasUrl = document.getElementById('lineGasUrl').value.trim();
            const gasSecret = document.getElementById('lineGasSecret').value.trim();
            const lineToken = document.getElementById('lineToken').value.trim();
            const lineUserId = document.getElementById('lineUserId').value.trim();
            if (!gasUrl || !gasSecret || !lineToken || !lineUserId) {
                console.log('LINE è¨­å®šä¸å®Œæ•´');
                return { success: false, error: 'è¨­å®šä¸å®Œæ•´' };
            }
            try {
                const response = await fetch(gasUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ secret: gasSecret, token: lineToken, userId: lineUserId, message })
                });
                return { success: true };
            } catch (error) {
                console.error('LINE é€šçŸ¥éŒ¯èª¤:', error);
                return { success: false, error: error.message };
            }
        }
        async function testLineNotification() {
            const gasUrl = document.getElementById('lineGasUrl').value.trim();
            const gasSecret = document.getElementById('lineGasSecret').value.trim();
            const lineToken = document.getElementById('lineToken').value.trim();
            const lineUserId = document.getElementById('lineUserId').value.trim();
            if (!gasUrl || !gasSecret || !lineToken || !lineUserId) {
                showToast('âš ï¸', 'è«‹å¡«å¯«å®Œæ•´ LINE è¨­å®š');
                updateLineStatus('error', 'âŒ è¨­å®šä¸å®Œæ•´');
                return;
            }
            updateLineStatus('', 'ğŸ“¤ ç™¼é€ä¸­...');
            showToast('ğŸ“¤', 'æ­£åœ¨ç™¼é€æ¸¬è©¦é€šçŸ¥...');
            const result = await sendLineNotification('ğŸ§ª æ¸¬è©¦é€šçŸ¥\n\nğŸ“· AI æ‹ç«‹å¾— v3 å·²é€£æ¥ï¼\nâœ… LINE é€šçŸ¥åŠŸèƒ½æ­£å¸¸');
            if (result.success) {
                showToast('âœ…', 'æ¸¬è©¦é€šçŸ¥å·²ç™¼é€ï¼ˆè«‹æª¢æŸ¥ LINEï¼‰');
                updateLineStatus('success', 'âœ… æ¸¬è©¦é€šçŸ¥å·²ç™¼é€');
            } else {
                showToast('âš ï¸', 'å·²å˜—è©¦ç™¼é€ï¼ˆno-cors æ¨¡å¼ï¼‰');
                updateLineStatus('success', 'âš ï¸ å·²ç™¼é€ï¼ˆè«‹æª¢æŸ¥ LINEï¼‰');
            }
        }
        function updateLineStatus(type, message) {
            const el = document.getElementById('lineStatus');
            el.style.display = 'block';
            el.className = `auth-status ${type}`;
            el.textContent = message;
        }

        async function uploadCurrentPhoto() {
            if (!currentPhotoId) return;
            const photo = await getPhoto(currentPhotoId);
            if (!photo) return;
            const result = await uploadToGooglePhotos(photo.data, currentPhotoId);
            if (result.success) {
                showToast('âœ…', 'ä¸Šå‚³æˆåŠŸï¼');
                document.getElementById('viewerUploadStatus').textContent = 'â˜ï¸ å·²ä¸Šå‚³';
                if (lineNotifyEnabled) await sendLineNotification(`ğŸ“· ç…§ç‰‡å·²ä¸Šå‚³ï¼\nâ° ${new Date().toLocaleString('zh-TW')}\nâ˜ï¸ å·²åŒæ­¥ Google ç›¸ç°¿`);
                await updateGallery();
            }
        }
        async function uploadAllPending() {
            const photos = await getAllPhotos();
            const pending = photos.filter(p => !p.uploaded);
            if (pending.length === 0) { showToast('âœ…', 'æ²’æœ‰å¾…ä¸Šå‚³ç…§ç‰‡'); return; }
            if (!isTokenValid()) { showToast('âš ï¸', 'è«‹å…ˆæˆæ¬Š Google'); showPage('cloud'); return; }
            showUploadProgress('æº–å‚™ä¸Šå‚³...', 0);
            let success = 0;
            for (let i = 0; i < pending.length; i++) {
                showUploadProgress(`ä¸Šå‚³ä¸­ ${i + 1}/${pending.length}`, ((i + 1) / pending.length) * 100);
                const result = await uploadToGooglePhotos(pending[i].data, pending[i].id);
                if (result.success) success++;
                await new Promise(r => setTimeout(r, 500));
            }
            hideUploadProgress();
            showToast('âœ…', `ä¸Šå‚³å®Œæˆï¼š${success}/${pending.length}`);
            if (lineNotifyEnabled && success > 0) await sendLineNotification(`ğŸ“· æ‰¹æ¬¡ä¸Šå‚³å®Œæˆï¼\nâœ… æˆåŠŸï¼š${success} å¼µ\nâ° ${new Date().toLocaleString('zh-TW')}`);
            await updateGallery();
        }
        function showUploadProgress(text, percent) {
            document.getElementById('uploadProgressText').textContent = text;
            document.getElementById('uploadProgressPercent').textContent = Math.round(percent) + '%';
            document.getElementById('uploadProgressFill').style.width = percent + '%';
            document.getElementById('uploadProgress').classList.add('active');
        }
        function hideUploadProgress() { document.getElementById('uploadProgress').classList.remove('active'); }

        // AI Analysis
        async function analyzeWithAI() {
            if (!currentPhotoId) return;
            if (!geminiApiKey) { showToast('âš ï¸', 'è«‹å…ˆè¨­å®š Gemini API Key'); return; }
            const photo = await getPhoto(currentPhotoId);
            if (!photo) return;
            const aiResult = document.getElementById('viewerAiResult');
            const aiText = document.getElementById('viewerAiText');
            aiResult.classList.add('active');
            aiText.textContent = 'æ­£åœ¨åˆ†æç…§ç‰‡...';
            try {
                const base64Data = photo.data.split(',')[1];
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ inline_data: { mime_type: 'image/jpeg', data: base64Data } }, { text: 'è«‹ç”¨ç¹é«”ä¸­æ–‡æè¿°é€™å¼µç…§ç‰‡ï¼ŒåŒ…å«ï¼š1. ä¸»è¦å…§å®¹ï¼ˆ50å­—å…§ï¼‰2. æƒ…å¢ƒæ°›åœ 3. é©åˆçš„æ¨™é¡Œã€‚ç°¡æ½”æœ‰è©©æ„ã€‚' }] }] })
                });
                const result = await res.json();
                const description = result.candidates?.[0]?.content?.parts?.[0]?.text || 'ç„¡æ³•åˆ†æ';
                aiText.textContent = description;
                await updatePhoto(currentPhotoId, { aiDescription: description });
            } catch (error) { aiText.textContent = 'åˆ†æå¤±æ•—ï¼š' + error.message; }
        }

        // Camera
        let cameraActive = false;
        
        async function initCamera(facingMode) {
            try {
                // åœæ­¢ç¾æœ‰ä¸²æµ
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                // ä½¿ç”¨å‚³å…¥çš„ facingMode æˆ–ç•¶å‰è¨­å®š
                const facing = facingMode || currentCamera || 'user';
                
                console.log('åˆå§‹åŒ–ç›¸æ©Ÿï¼Œé¡é ­:', facing);
                
                // è¨­å®š facingMode - ä½¿ç”¨ exact ç¢ºä¿åˆ‡æ›æˆåŠŸ
                let videoConstraints;
                if (facing === 'environment') {
                    // å¾Œé¡é ­ - ä½¿ç”¨ exact å¼·åˆ¶åˆ‡æ›
                    videoConstraints = {
                        facingMode: { exact: 'environment' },
                        width: { ideal: 720 },
                        height: { ideal: 720 }
                    };
                } else {
                    // å‰é¡é ­
                    videoConstraints = {
                        facingMode: 'user',
                        width: { ideal: 720 },
                        height: { ideal: 720 }
                    };
                }
                
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: videoConstraints, 
                        audio: false 
                    });
                } catch (exactError) {
                    // å¦‚æœ exact å¤±æ•—ï¼Œå˜—è©¦ä¸ç”¨ exact
                    console.log('exact æ¨¡å¼å¤±æ•—ï¼Œå˜—è©¦ä¸€èˆ¬æ¨¡å¼:', exactError);
                    stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: facing,
                            width: { ideal: 720 }, 
                            height: { ideal: 720 } 
                        }, 
                        audio: false 
                    });
                }
                
                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;
                
                // ç¢ºä¿ video é–‹å§‹æ’­æ”¾
                await video.play().catch(e => console.log('Video play:', e));
                
                cameraActive = true;
                currentCamera = facing;
                console.log('ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œé¡é ­:', facing);
                
            } catch (error) { 
                console.error('ç›¸æ©Ÿåˆå§‹åŒ–å¤±æ•—:', error); 
                showToast('âŒ', 'ç„¡æ³•åˆ‡æ›é¡é ­'); 
                cameraActive = false;
            }
        }
        
        // ç›¸æ©Ÿä¼‘çœ æ¢å¾© - å¼·åˆ¶æª¢æŸ¥
        function checkAndRestoreCamera() {
            const video = document.getElementById('cameraPreview');
            const hint = document.getElementById('lensTapHint');
            if (!video) return;
            
            let needsRestart = false;
            
            // æª¢æŸ¥å„ç¨®æƒ…æ³
            if (!stream) {
                console.log('ä¸²æµä¸å­˜åœ¨');
                needsRestart = true;
            } else if (!video.srcObject) {
                console.log('video.srcObject ä¸å­˜åœ¨');
                needsRestart = true;
            } else {
                const tracks = stream.getVideoTracks();
                if (tracks.length === 0) {
                    console.log('æ²’æœ‰è¦–è¨Šè»Œé“');
                    needsRestart = true;
                } else if (tracks.every(t => t.readyState === 'ended')) {
                    console.log('æ‰€æœ‰è»Œé“å·²çµæŸ');
                    needsRestart = true;
                } else if (tracks.every(t => !t.enabled)) {
                    console.log('æ‰€æœ‰è»Œé“è¢«ç¦ç”¨');
                    needsRestart = true;
                }
            }
            
            // é¡¯ç¤º/éš±è—æç¤º
            if (hint) {
                hint.style.opacity = needsRestart ? '1' : '0';
            }
            
            // é¡å¤–æª¢æŸ¥ï¼švideo æ˜¯å¦æš«åœ
            if (!needsRestart && video.paused) {
                console.log('video å·²æš«åœï¼Œå˜—è©¦æ’­æ”¾');
                video.play().catch(() => {
                    console.log('æ’­æ”¾å¤±æ•—ï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–');
                    if (hint) hint.style.opacity = '1';
                    initCamera(currentCamera);
                });
                return;
            }
            
            if (needsRestart) {
                console.log('é‡æ–°åˆå§‹åŒ–ç›¸æ©Ÿï¼Œé¡é ­:', currentCamera);
                showToast('ğŸ“·', 'æ¢å¾©ç›¸æ©Ÿä¸­...');
                initCamera(currentCamera).then(() => {
                    if (hint) hint.style.opacity = '0';
                });
            }
        }
        
        function handleVisibilityChange() {
            console.log('visibilitychange:', document.visibilityState);
            if (document.visibilityState === 'visible') {
                // å¤šæ¬¡æª¢æŸ¥ï¼Œç¢ºä¿æ¢å¾©
                setTimeout(checkAndRestoreCamera, 100);
                setTimeout(checkAndRestoreCamera, 500);
                setTimeout(checkAndRestoreCamera, 1000);
                setTimeout(checkAndRestoreCamera, 2000);
            }
        }
        
        function handleFocus() {
            console.log('window focus');
            setTimeout(checkAndRestoreCamera, 100);
            setTimeout(checkAndRestoreCamera, 500);
            setTimeout(checkAndRestoreCamera, 1500);
        }
        
        // ç›£è½é é¢å¯è¦‹æ€§è®ŠåŒ–å’Œè¦–çª—ç„¦é»
        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('focus', handleFocus);
        window.addEventListener('pageshow', (e) => {
            console.log('pageshow, persisted:', e.persisted);
            setTimeout(checkAndRestoreCamera, 100);
            setTimeout(checkAndRestoreCamera, 500);
            setTimeout(checkAndRestoreCamera, 1500);
        });
        
        // å…¨åŸŸé»æ“Š/è§¸æ§æ¢å¾©
        document.addEventListener('click', () => {
            if (document.visibilityState === 'visible') {
                checkAndRestoreCamera();
            }
        }, { passive: true });
        
        document.addEventListener('touchend', () => {
            if (document.visibilityState === 'visible') {
                checkAndRestoreCamera();
            }
        }, { passive: true });
        
        // å®šæœŸæª¢æŸ¥ç›¸æ©Ÿç‹€æ…‹ï¼ˆæ¯ 2 ç§’ï¼‰
        setInterval(() => {
            if (document.visibilityState === 'visible' && !document.hidden) {
                checkAndRestoreCamera();
            }
        }, 2000);
        
        let isFlipping = false;
        async function flipCamera() {
            if (isFlipping) return;
            isFlipping = true;
            
            try {
                const newCamera = currentCamera === 'user' ? 'environment' : 'user';
                console.log('åˆ‡æ›é¡é ­:', currentCamera, '->', newCamera);
                
                showToast('ğŸ”„', 'åˆ‡æ›ä¸­...');
                
                await initCamera(newCamera);
                
                showToast('ğŸ“·', currentCamera === 'user' ? 'å‰é¡é ­' : 'å¾Œé¡é ­');
                saveSettings();
            } catch (e) {
                console.error('åˆ‡æ›å¤±æ•—:', e);
                showToast('âŒ', 'åˆ‡æ›å¤±æ•—');
            } finally {
                isFlipping = false;
            }
        }
        function toggleFlash() {
            flashEnabled = !flashEnabled;
            document.getElementById('flashBtn').classList.toggle('active', flashEnabled);
            showToast('âš¡', flashEnabled ? 'é–ƒå…‰ç‡ˆé–‹' : 'é–ƒå…‰ç‡ˆé—œ');
        }
        function cycleTimer() {
            const times = [0, 3, 5, 10];
            timerSeconds = times[(times.indexOf(timerSeconds) + 1) % times.length];
            document.getElementById('timerBtn').classList.toggle('active', timerSeconds > 0);
            showToast('â±', timerSeconds === 0 ? 'è¨ˆæ™‚å™¨é—œé–‰' : `${timerSeconds} ç§’`);
        }
        function cycleFilter() {
            const idx = (filters.findIndex(f => f.id === currentFilter) + 1) % filters.length;
            currentFilter = filters[idx].id;
            document.getElementById('cameraPreview').style.filter = filters[idx].css;
            document.getElementById('filterBtn').classList.toggle('active', currentFilter !== 'none');
            showToast('ğŸ¨', filters[idx].name);
        }
        function selectFrame(frameId, el) {
            currentFrame = frameId;
            document.querySelectorAll('.frame-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
        }

        let isTakingPhoto = false;
        
        async function takePhoto() {
            if (isTakingPhoto) return;
            isTakingPhoto = true;
            
            try {
                if (timerSeconds > 0) {
                    for (let i = timerSeconds; i > 0; i--) { updateIsland('â±', `${i} ç§’`); await new Promise(r => setTimeout(r, 1000)); }
                }
                await capturePhoto();
            } finally {
                setTimeout(() => { isTakingPhoto = false; }, 500);
            }
        }
        async function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const size = Math.min(video.videoWidth, video.videoHeight);
            canvas.width = size; canvas.height = size;
            if (flashEnabled) {
                document.getElementById('flashOverlay').classList.add('active');
                document.getElementById('camFlash').style.boxShadow = '0 0 30px 10px rgba(255,255,255,0.8)';
                setTimeout(() => { document.getElementById('flashOverlay').classList.remove('active'); document.getElementById('camFlash').style.boxShadow = ''; }, 150);
            }
            if (soundEnabled) playShutterSound();
            ctx.save();
            if (currentCamera === 'user') { ctx.scale(-1, 1); ctx.translate(-canvas.width, 0); }
            const filter = filters.find(f => f.id === currentFilter);
            if (filter && filter.css) ctx.filter = filter.css;
            const offsetX = (video.videoWidth - size) / 2, offsetY = (video.videoHeight - size) / 2;
            ctx.drawImage(video, offsetX, offsetY, size, size, 0, 0, size, size);
            ctx.restore();
            const imageData = canvas.toDataURL('image/jpeg', 0.85);
            const polaroidData = await createPolaroidImage(imageData, currentFrame);
            showFilmEject(polaroidData);
            const photo = await savePhotoToDB(polaroidData, currentFrame);
            filmCount = Math.max(0, filmCount - 1);
            document.getElementById('filmCounter').textContent = filmCount;
            setTimeout(() => createScatteredPhoto(polaroidData, photo.id), 3500);
            await updateGallery();
            if (autoUploadEnabled && isTokenValid()) {
                setTimeout(async () => {
                    const result = await uploadToGooglePhotos(polaroidData, photo.id);
                    if (result.success) { showToast('â˜ï¸', 'å·²è‡ªå‹•ä¸Šå‚³'); if (lineNotifyEnabled) await sendLineNotification(`ğŸ“· æ–°ç…§ç‰‡å·²è‡ªå‹•ä¸Šå‚³ï¼\nâ° ${new Date().toLocaleString('zh-TW')}`); await updateGallery(); }
                }, 4000);
            }
            updateIsland('ğŸ“·', 'AI æ‹ç«‹å¾— v3');
        }
        async function createPolaroidImage(imageData, frameType) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const padding = 30, bottomPadding = 80;
                    canvas.width = img.width + padding * 2;
                    canvas.height = img.height + padding + bottomPadding;
                    const frameColors = { white: '#ffffff', black: '#1a1a1a', mint: '#a8e6cf', pink: '#ffb6c1', floral: '#ffefd5', plaid: '#b0c4de', gradient: null };
                    if (frameType === 'gradient') {
                        const grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                        grad.addColorStop(0, '#ff9a9e'); grad.addColorStop(0.5, '#fecfef'); grad.addColorStop(1, '#a18cd1');
                        ctx.fillStyle = grad;
                    } else { ctx.fillStyle = frameColors[frameType] || '#ffffff'; }
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, padding, padding);
                    resolve(canvas.toDataURL('image/jpeg', 0.9));
                };
                img.src = imageData;
            });
        }
        function showFilmEject(imageData) {
            const film = document.getElementById('polaroidFilm');
            const filmImg = document.getElementById('filmImage');
            const developing = document.getElementById('filmDeveloping');
            const filmText = document.getElementById('filmText');
            film.className = 'polaroid-film ' + frames[currentFrame].class;
            filmText.style.color = frames[currentFrame].textColor;
            filmImg.src = imageData;
            filmImg.classList.remove('developed');
            developing.classList.remove('hidden');
            film.classList.add('ejecting');
            setTimeout(() => { developing.classList.add('hidden'); filmImg.classList.add('developed'); }, 1500);
            setTimeout(() => { film.classList.remove('ejecting'); showToast('ğŸ“¸', 'ç…§ç‰‡å·²å„²å­˜'); }, 4000);
        }

        // æ•£è½ç…§ç‰‡ï¼ˆå¯æ‹–æ›³ï¼‰
        function createScatteredPhoto(imageData, photoId) {
            const container = document.getElementById('scatteredPhotos');
            const photo = document.createElement('div');
            photo.className = 'scattered-photo';
            photo.dataset.photoId = photoId;
            const randomX = Math.random() * 60 + 10;
            const randomY = Math.random() * 25 + 5;
            const randomRotate = Math.random() * 30 - 15;
            photo.style.cssText = `left: ${randomX}%; top: ${randomY}%; transform: rotate(${randomRotate}deg);`;
            photo.innerHTML = `<img src="${imageData}" alt="Photo"><div class="photo-text">âœ¨</div>`;
            
            // æ‹–æ›³åŠŸèƒ½
            let isDragging = false, startX, startY, initialX, initialY;
            
            const onStart = (e) => {
                e.preventDefault();
                isDragging = true;
                photo.classList.add('dragging');
                const touch = e.touches ? e.touches[0] : e;
                startX = touch.clientX;
                startY = touch.clientY;
                const rect = photo.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;
            };
            
            const onMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                const deltaX = touch.clientX - startX;
                const deltaY = touch.clientY - startY;
                photo.style.left = `${initialX + deltaX}px`;
                photo.style.top = `${initialY + deltaY}px`;
                photo.style.transform = 'rotate(0deg) scale(1.05)';
            };
            
            const onEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                photo.classList.remove('dragging');
                photo.style.transform = `rotate(${randomRotate}deg)`;
            };
            
            // é»æ“ŠæŸ¥çœ‹ï¼ˆéæ‹–æ›³æ™‚ï¼‰
            let clickTimer;
            photo.addEventListener('mousedown', (e) => {
                clickTimer = Date.now();
                onStart(e);
            });
            photo.addEventListener('touchstart', (e) => {
                clickTimer = Date.now();
                onStart(e);
            }, { passive: false });
            
            document.addEventListener('mousemove', onMove);
            document.addEventListener('touchmove', onMove, { passive: false });
            
            document.addEventListener('mouseup', (e) => {
                if (isDragging && Date.now() - clickTimer < 200) {
                    viewPhoto(photoId);
                }
                onEnd();
            });
            document.addEventListener('touchend', (e) => {
                if (isDragging && Date.now() - clickTimer < 200) {
                    viewPhoto(photoId);
                }
                onEnd();
            });
            
            container.appendChild(photo);
            while (container.children.length > 5) container.removeChild(container.firstChild);
        }

        function playShutterSound() {
            try {
                const audio = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audio.createOscillator();
                const gain = audio.createGain();
                osc.connect(gain); gain.connect(audio.destination);
                osc.frequency.value = 800;
                gain.gain.setValueAtTime(0.3, audio.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audio.currentTime + 0.1);
                osc.start(audio.currentTime); osc.stop(audio.currentTime + 0.1);
            } catch(e) {}
        }

        // UI
        function initThemeSelector() {
            const grid = document.getElementById('themeGrid');
            themes.forEach(t => {
                const item = document.createElement('div');
                item.className = `theme-option ${t.id === currentTheme ? 'active' : ''}`;
                item.innerHTML = `<div class="theme-preview ${t.id}"></div><span class="theme-name">${t.name}</span>`;
                item.onclick = () => selectTheme(t.id);
                grid.appendChild(item);
            });
        }
        function selectTheme(themeId) {
            currentTheme = themeId;
            document.body.className = `theme-${themeId}`;
            document.querySelectorAll('.theme-option').forEach(el => el.classList.toggle('active', el.querySelector(`.theme-preview.${themeId}`)));
            saveSettings();
            showToast('ğŸ¨', themes.find(t => t.id === themeId)?.name);
        }
        async function updateGallery() {
            const photos = await getAllPhotos();
            const grid = document.getElementById('photoGrid');
            const empty = document.getElementById('photoEmpty');
            const uploadedCount = photos.filter(p => p.uploaded).length;
            document.getElementById('photoCount').textContent = photos.length;
            document.getElementById('uploadedCount').textContent = uploadedCount;
            document.getElementById('pendingCount').textContent = photos.length - uploadedCount;
            if (photos.length === 0) { grid.style.display = 'none'; empty.style.display = 'flex'; return; }
            grid.style.display = 'grid'; empty.style.display = 'none';
            grid.innerHTML = photos.map(p => `<div class="photo-thumb" onclick="viewPhoto(${p.id})"><img src="${p.data}" alt="Photo"><span class="upload-badge">${p.uploaded ? 'â˜ï¸' : 'ğŸ“±'}</span></div>`).join('');
            let totalSize = 0; photos.forEach(p => totalSize += p.data.length * 0.75);
            document.getElementById('storageSize').textContent = totalSize > 1024 * 1024 ? `${(totalSize / 1024 / 1024).toFixed(1)} MB` : `${(totalSize / 1024).toFixed(0)} KB`;
        }
        async function viewPhoto(id) {
            currentPhotoId = id;
            const photo = await getPhoto(id);
            if (!photo) return;
            document.getElementById('viewerImage').src = photo.data;
            document.getElementById('viewerUploadStatus').textContent = photo.uploaded ? 'â˜ï¸ å·²ä¸Šå‚³' : 'ğŸ“± æœ¬æ©Ÿ';
            document.getElementById('photoViewer').classList.add('active');
            const aiResult = document.getElementById('viewerAiResult');
            if (photo.aiDescription) { document.getElementById('viewerAiText').textContent = photo.aiDescription; aiResult.classList.add('active'); }
            else { aiResult.classList.remove('active'); }
        }
        function closeViewer() {
            document.getElementById('photoViewer').classList.remove('active');
            document.getElementById('viewerAiResult').classList.remove('active');
            currentPhotoId = null;
        }
        async function downloadCurrentPhoto() {
            if (!currentPhotoId) return;
            const photo = await getPhoto(currentPhotoId);
            if (!photo) return;
            const link = document.createElement('a');
            link.download = `polaroid_${currentPhotoId}.jpg`;
            link.href = photo.data;
            link.click();
            showToast('â¬‡ï¸', 'ç…§ç‰‡å·²ä¸‹è¼‰');
        }
        async function deleteCurrentPhoto() {
            if (!currentPhotoId) return;
            if (!confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) return;
            await deletePhotoFromDB(currentPhotoId);
            closeViewer();
            await updateGallery();
            showToast('ğŸ—‘ï¸', 'ç…§ç‰‡å·²åˆªé™¤');
        }
        async function clearAllPhotos() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰ç…§ç‰‡ï¼Ÿ')) return;
            await clearAllPhotosFromDB();
            document.getElementById('scatteredPhotos').innerHTML = '';
            await updateGallery();
            showToast('ğŸ—‘ï¸', 'å·²æ¸…é™¤æ‰€æœ‰ç…§ç‰‡');
        }
        function switchTab(tab) {
            document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
            if (tab !== 'camera') showPage(tab);
        }
        function showPage(pageId) { document.getElementById(pageId + 'Page').classList.add('active'); }
        function closePage(pageId) { document.getElementById(pageId + 'Page').classList.remove('active'); document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.tab === 'camera')); }
        function toggleSetting(setting) {
            switch (setting) {
                case 'sound': soundEnabled = !soundEnabled; document.getElementById('soundSwitch').classList.toggle('active', soundEnabled); break;
                case 'autoUpload': autoUploadEnabled = !autoUploadEnabled; document.getElementById('autoUploadSwitch').classList.toggle('active', autoUploadEnabled); break;
                case 'lineNotify': lineNotifyEnabled = !lineNotifyEnabled; document.getElementById('lineNotifySwitch').classList.toggle('active', lineNotifyEnabled); break;
            }
            saveSettings();
        }
        function showAPIKeyInput() {
            const key = prompt('è«‹è¼¸å…¥ Gemini API Keyï¼š', geminiApiKey);
            if (key !== null) { geminiApiKey = key.trim(); document.getElementById('apiStatus').textContent = geminiApiKey ? 'âœ“ å·²è¨­å®š' : 'æœªé€£æ¥'; document.getElementById('apiStatus').style.color = geminiApiKey ? 'var(--ios-green)' : ''; saveSettings(); }
        }
        function saveSettings() { localStorage.setItem('polaroid_settings', JSON.stringify({ currentTheme, soundEnabled, geminiApiKey, autoUploadEnabled, lineNotifyEnabled, currentFrame, currentFilter, currentCamera })); }
        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('polaroid_settings'));
                if (settings) {
                    currentTheme = settings.currentTheme || 'sky'; 
                    soundEnabled = settings.soundEnabled !== false; 
                    geminiApiKey = settings.geminiApiKey || ''; 
                    autoUploadEnabled = settings.autoUploadEnabled || false; 
                    lineNotifyEnabled = settings.lineNotifyEnabled !== false; 
                    currentFrame = settings.currentFrame || 'white'; 
                    currentFilter = settings.currentFilter || 'none';
                    currentCamera = settings.currentCamera || 'user';
                    
                    console.log('è¼‰å…¥è¨­å®šï¼Œé¡é ­:', currentCamera);
                    
                    document.body.className = `theme-${currentTheme}`;
                    document.getElementById('soundSwitch').classList.toggle('active', soundEnabled);
                    document.getElementById('autoUploadSwitch').classList.toggle('active', autoUploadEnabled);
                    document.getElementById('lineNotifySwitch').classList.toggle('active', lineNotifyEnabled);
                    if (geminiApiKey) { document.getElementById('apiStatus').textContent = 'âœ“ å·²è¨­å®š'; document.getElementById('apiStatus').style.color = 'var(--ios-green)'; }
                    document.querySelectorAll('.frame-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.frame === currentFrame));
                }
            } catch (e) { console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', e); }
        }
        function loadCloudSettings() {
            try {
                // è¼‰å…¥ç¨ç«‹æ¬„ä½è¨­å®š
                loadFieldSettings();
                
                // è¼‰å…¥èˆŠç‰ˆ Google è¨­å®šï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
                const google = JSON.parse(localStorage.getItem('polaroid_google'));
                if (google && google.googleClientId) { 
                    document.getElementById('googleClientId').value = google.googleClientId; 
                }
                
                // è¼‰å…¥èˆŠç‰ˆ LINE è¨­å®šï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
                const line = JSON.parse(localStorage.getItem('polaroid_line'));
                if (line) {
                    if (line.lineGasUrl) document.getElementById('lineGasUrl').value = line.lineGasUrl;
                    if (line.lineGasSecret) document.getElementById('lineGasSecret').value = line.lineGasSecret;
                    if (line.lineToken) document.getElementById('lineToken').value = line.lineToken;
                    if (line.lineUserId) document.getElementById('lineUserId').value = line.lineUserId;
                }
                
                if (isTokenValid()) updateAuthStatus('success', 'âœ… å·²æˆæ¬Šï¼ˆ24å°æ™‚æœ‰æ•ˆï¼‰');
            } catch (e) { console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', e); }
        }
        function updateIsland(icon, text) {
            document.getElementById('dynamicIsland').querySelector('.island-icon').textContent = icon;
            document.getElementById('islandText').textContent = text;
        }
        function showToast(icon, text) {
            const toast = document.getElementById('toast');
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastText').textContent = text;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2500);
        }

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            const progressBar = document.getElementById('bootProgressBar');
            const statusText = document.getElementById('bootStatus');
            try {
                progressBar.style.width = '15%'; statusText.textContent = 'åˆå§‹åŒ–è³‡æ–™åº«...';
                await initDB(); await new Promise(r => setTimeout(r, 300));
                
                progressBar.style.width = '35%'; statusText.textContent = 'è¼‰å…¥è¨­å®š...';
                loadSettings(); loadCloudSettings(); await new Promise(r => setTimeout(r, 200));
                
                progressBar.style.width = '50%'; statusText.textContent = 'è¼‰å…¥ç›¸æ©Ÿ...';
                console.log('åˆå§‹åŒ–ç›¸æ©Ÿï¼Œä½¿ç”¨é¡é ­:', currentCamera);
                await initCamera(currentCamera); await new Promise(r => setTimeout(r, 400));
                
                progressBar.style.width = '65%'; statusText.textContent = 'æº–å‚™ä»‹é¢...';
                initThemeSelector(); await new Promise(r => setTimeout(r, 300));
                
                progressBar.style.width = '85%'; statusText.textContent = 'è¼‰å…¥ç…§ç‰‡...';
                await updateGallery(); await new Promise(r => setTimeout(r, 300));
                
                progressBar.style.width = '100%'; statusText.textContent = 'æº–å‚™å®Œæˆï¼';
                await new Promise(r => setTimeout(r, 600));
                document.getElementById('bootScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.add('loaded');
                setTimeout(() => document.getElementById('bootScreen').remove(), 1000);
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                statusText.textContent = 'åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†';
                statusText.style.color = '#FF453A';
            }
        });
    </script>
</body>
</html>
